---
title: "Imputasi SKIM23"
author: "Ayu Paramudita"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: '2'
  html_document:
    toc: true
    toc_depth: 2
  word_document:
    toc: true
    toc_depth: '2'
code-fold: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(dplyr)
library(knitr)
library(writexl)
library(tidyr)
library(ggplot2)

#package untuk machine learning
library(caret)
library(Metrics)
library(randomForest)
```

# Pendahuluan

Dokumen ini adalah dokumentasi proses imputasi SKIM 2023. Data yang diimputasi meliputi data tidak lengkap dari webentry SKIM 2023 dan observasi yang eligibel namun belum masuk ke webentry. Adapun variabel dan metode imputasi yang digunakan sebagai berikut:

- Bulan operasi : data historis

- Tenaga kerja : data historis

- Pengeluaran pekerja : data historis dengan adjustment pertumbuhan rata-rata upah minimum

- Biaya input, meliputi bahan baku dan penolong domestik, bahan baku penolong impor, bahan bakar, dan listrik : data historis dengan adjustment pertumbuhan input menurut kbli2, provinsi, dan skala tk

- Total output : machine learning (Random Forest dan K-Nearest Neighbour)


# Persiapan data

## Load data

```{r, warning=FALSE}
dpa23   <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/DPA NASIONAL tahun 2023.xlsx")
dpa24 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/DPA (CAPI) NASIONAL tahun 2024.xlsx")
skim23  <- read_xlsx("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/SKIM.IIADetail NASIONAL tahun 2024.xlsx")

stpim23 <- read_xlsx("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/STPIM (CAWI) NASIONAL tahun 2024.xlsx")
weight23 <- read.csv2("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/2024-12-23 10_02_52 Weight STPIM 2024(Sheet1).csv")

stpim22 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg22.xlsx")
stpim21 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg21e.xlsx")


```


## Data DPA23 TPT

```{r }
dpa23_tpt <- dpa23 |>
  mutate(kbli2_dpa23 = substr(b2r217, 1, 2)) |>
  filter(b2r205 == 1,                            # kondisi aktif
         b2r210 != 4,                            # bukan kantor pusat
         kbli2_dpa23 == 13 | kbli2_dpa23 == 14   # kbli 13 dan 14
         ) |>
  select(kip, prov, kab, b2r217, kbli2_dpa23, b2r216, b2r205, b2r210, b2r224, b2r225, b2r226, b2r218)

# Buat tabel
tab_dpa23tpt <- table(dpa23_tpt$kbli2_dpa23)
tab_dpa23tpt <- as.data.frame(tab_dpa23tpt) |>
  rename(KBLI = Var1,
         N    = Freq) 

total_dpatpt23 <- data.frame(KBLI = "Total", N = sum(tab_dpa23tpt$N))
tab_dpa23tpt <- rbind(tab_dpa23tpt, total_dpatpt23)
tab_dpa23tpt <- kable(tab_dpa23tpt)

```

Referensi **target usaha awal**: DPA23 kondisi 1 (aktif), KBLI 13-14, dan selain kantor pusat. *Kenapa **target usaha awal**? Karena nanti di akhir setelah imputasi akan dicek kembali (range tenaga kerja, investasi, omset, badan usaha/hukum, dll dari DPA23) mana yang layak masuk sebagai mfg/data final.*

Jumlah target usaha TPT (KBLI 13 & 14) menurut DPA23: **`r nrow(dpa23_tpt)`**. 

Dengan rincian sebagai berikut: `r tab_dpa23tpt`.


## Data SKIM23

```{r }
skim23 <- skim23 |>
  mutate(kbli2 = substr(r201_kode, 1, 2))

#Buat tabel
tab_skim23 <- table(skim23$kbli2)
tab_skim23 <- as.data.frame(tab_skim23) |>
  rename(KBLI = Var1,
         N    = Freq) 

total_skim23 <- data.frame(KBLI = "Total", N = sum(tab_skim23$N))
tab_skim23 <- rbind(tab_skim23, total_skim23)
tab_skim23 <- kable(tab_skim23)

#KBLI NA
nkbli_na <- sum(is.na(skim23$kbli2))   

#SKIM23 Tidak Lengkap
skim23_tl <- skim23 |>
  filter(tidak_lengkap == 1)

```

Jumlah perusahaan TPT di SKIM23 : **`r nrow(skim23)`**

`r tab_skim23`

KBLI SKIM23 yang NA sebanyak `r nkbli_na`.

Sebanyak `r nrow(skim23_tl)` perusahaan tidak mengisi kuesioner SKIM23 secara lengkap. 

SKIM23 tidak lengkap dan target usaha TPT yang belum ada diwebentri akan diimputasi.


# Target imputasi

## Target imputasi dari SKIM23 tidak lengkap (TL)

### Pengecekan KBLI

```{r, warning=FALSE}
#Cek KBLI NA TL
nkbli_na_tl <- sum(is.na(skim23_tl$kbli2))

```

Setelah dilakukan pengecekan KBLI untuk SKIM23 TL, sebanyak `r nkbli_na_tl` KIP tidak terisi KBLInya.


### Imputasi KBLI dan produk

Pengecekan dan imputasi KBLI diperlukan karena KBLI sebagai dasar imputasi variabel lain.

- Mengimputasi KBLI yang tidak terisi dengan data KBLI dari DPA23 atau DPA24.

```{r}
#Imputasi KBLI
skim23_tl <- skim23_tl |>
  #input kbli NA dari DPA23
  left_join(dpa23 |> select(kip, b2r217), by = "kip") |>
  mutate(r201_kode = ifelse(is.na(r201_kode), b2r217, r201_kode),
         kbli2     = substr(r201_kode, 1, 2)) |>
  #input kbli NA atau kbli non TPT dari DPA24
  left_join(dpa24 |> select(kip, kbli5digit), by = "kip") |>
  mutate(r201_kode = ifelse(is.na(r201_kode) | (kbli2 != 13 & kbli2 !=14), kbli5digit, r201_kode),
         kbli2     = substr(r201_kode, 1, 2))

#TL non eligible SKIM23
skim23_tl_nontpt <- skim23_tl |>
  filter(is.na(skim23_tl$r201_kode) | 
                          (skim23_tl$kbli2 != 13 & skim23_tl$kbli2 != 14))

#Exclude non eligible SKIM23
skim23_tl_target <- skim23_tl |>
  filter(!(is.na(r201_kode) | (kbli2 != 13 & kbli2 != 14)))

```

Selanjutnya, imputasi KBLI dilakukan dengan data KBLI dari DPA23 atau DPA24. Namun setelah dilakukan pengecekan kembali, terdapat `r nrow(skim23_tl_nontpt)` usaha tidak eligibel SKIM23 sehingga tidak dimasukkan ke dalam target imputasi, a.l. `r skim23_tl_nontpt$kip` (satu ganda, satu bukan TPT).

**Target imputasi dari SKIM23 TL sebanyak `r nrow(skim23_tl_target)`.**

- Mengimputasi produk yang masih NA dengan data produk dari DPA23 atau DPA24.

```{r}
#Imputasi produk
imptpt_produk <- skim23_tl_target |>
  filter(is.na(r202)) |>
  left_join(dpa23 |>
              select(kip, b2r216), by = "kip") |>
  left_join(dpa24 |>
              select(kip, produk), by = "kip") |>
  mutate(r202i = ifelse(is.na(b2r216), produk, b2r216))

#Combine imputasi produk di dataset utama
skim23_tl_target <- skim23_tl_target |>
  left_join(imptpt_produk |>
              select(kip, r202i), by = "kip") |>
  mutate(r202 = ifelse(is.na(r202), r202i, r202))

```


### Perbaikan konsistensi tenaga kerja

Mengecek konsistensi tenaga kerja dari isian yang respon. Kemudian melakukan perbaikan isian tenaga kerja untuk KIP dengan isian tenaga kerja tidak konsisten.

```{r}
skim23_tl_target <- skim23_tl_target |> 
  #mengecek apakah isian tk konsisten dengan total tk
  mutate(r206a_cek = rowSums(across(c(r206b_1, r206b_2)), na.rm = TRUE) - 
                      rowSums(across(c(r206c_1, r206c_2)), na.rm = TRUE))

#Cek KIP yang isian tk tidak konsiten dengan total tk
cekskim23tl_tk <- skim23_tl_target |>
  filter(r206a_cek != 0 | r206a == 0) |>
  #perbaikan konsistensi tk
  ##imputasi tk produksi agar konsisten
  mutate(r206c_1 = ifelse(r206c_1 == 0 | is.na(r206c_1), r206a, r206c_1), 
         r206b_1 = ifelse(is.na(r206b_1), r206a, r206b_1)) |>
  ##imputasi tk produksi agar konsisten
  mutate(r206c_1 = ifelse(r206a > rowSums(across(c(r206c_1, r206c_2)), na.rm = TRUE), 
                             r206a - r206c_2, 
                             r206c_1),
         r206c_1 = ifelse(r206c_1 == 539, 239, r206c_1),
         r206a   = ifelse(r206a == 0, rowSums(across(c(r206b_1, r206b_2)), na.rm = TRUE), r206a)) |>
  rename(r206ar = r206a,
         r206c_1r = r206c_1,
         r206b_1r = r206b_1)

#Perbaikan konsistensi tk
skim23_tl_target <- skim23_tl_target |> 
  left_join(cekskim23tl_tk |> select(kip, r206ar, r206b_1r, r206c_1r), by = "kip") |>
  mutate(r206a   = ifelse(!(is.na(r206ar)), r206ar, r206a),
         r206b_1 = ifelse(!(is.na(r206b_1r)), r206b_1r, r206b_1),
         r206c_1 = ifelse(!(is.na(r206c_1r)), r206c_1r, r206c_1)) |>
  #mengecek apakah isian tk konsisten dengan total tk
  mutate(r206a_cek1 = rowSums(across(c(r206b_1, r206b_2)), na.rm = TRUE) - 
                      rowSums(across(c(r206c_1, r206c_2)), na.rm = TRUE)) |>
  select(-r206ar, -r206b_1r, -r206c_1r)

```


## Target imputasi dengan dasar jumlah DPA23 TPT

```{r}
target_imptpt_dpa23 <- dpa23_tpt |>
  filter(!(kip %in% skim23$kip))

```

**Target imputasi TPT dari irisan DPA23 TPT yang belum masuk ke dalam webentri sebanyak `r nrow(target_imptpt_dpa23)`**.


### Cek DPA23 TPT dengan STPIM23-weight

Catatan: STPIM23-weight adalah dokumen berisi list KIP usaha STPIM23 dan penimbangnya.

```{r}
# Cek irisan DPA23 TPT dan weight STPIM23
cek_dpa23tpt_weight <- dpa23_tpt |>
  filter((kip %in% weight23$kipb))

```

Irisan DPA23 dan usaha di STPIM23-weight sebanyak `r nrow(cek_dpa23tpt_weight)`. Jika tidak ada irisan DPA23 TPT dengan weight, maka target imputasi TPT tetap **`r nrow(target_imptpt_dpa23)`**.


### Cek STPIM23 TPT dan STPIM23-weight

```{r, results='hide'}
# Cek usaha TPT di STPIM23
stpim23_tpt <- stpim23 |>
  mutate(kbli2 = substr(r201_kode, 1, 2)) |>
  filter(kbli2 == 13 | kbli2 == 14)

list_stpim23_tpt <- print(stpim23_tpt$kip)

```

Ternyata masih ada `r nrow(stpim23_tpt)` usaha TPT yang dicatat di STPIM23. 
Apakah `r nrow(stpim23_tpt)` usaha 13-14 STPIM23 ini ada di weight?

```{r}
# Cek irisan STPIM23 dan weight
cek_stpim23tpt_weight <- stpim23_tpt |>
  filter((kip %in% weight23$kipb))

```

Ada `r nrow(cek_stpim23tpt_weight)` usaha 13-14 yang ada di weight. Maka, dokumen weight harus diupdate dengan mengeluarkan 3 usaha 13-14 ini. KIP `r nrow(cek_stpim23tpt_weight)` perusahaan tersebut a.l.: `r cek_stpim23tpt_weight$kip`.

**`r nrow(stpim23_tpt)` usaha 13-14 STPIM23 harus masuk menjadi cakupan SKIM23**. *Jangan lupa untuk dimasukkan saat mengkompilasi data SKIM23 untuk tabulasi nanti*. KIP `r nrow(stpim23_tpt)` perusahaan tersebut a.l.:

`r list_stpim23_tpt`


### Cek konsistensi KBLI di STPIM dan DPA

Pengecekan dan imputasi KBLI diperlukan karena KBLI sebagai dasar imputasi variabel lain.

- Cek apakah ada target yang memiliki historis STPIM yang KBLI-nya bukan TPT.
- Cek KBLI dan produksi masing-masing perusahaan yang terindikasi bukan TPT.
- Keluarkan yang indikasinya bukan TPT.
- Update KBLI yang sudah dicek dengan imputasi dari sumber DPA yang dicek benar.
- KBLI dasar untuk imputasi yang digunakan adalah KBLI STPIM dengan asumsi pemeriksaan STPIM berjalan dengan benar.

```{r}
#Tambahkan Disic5 dan Produksi dari STPIM
target_imptpt_dpa23 <- target_imptpt_dpa23 |>
  left_join(stpim22 |> select(Kipb, Disic522, Produksi), by = c("kip" = "Kipb")) |>
  mutate(tahun22 = ifelse(is.na(Disic522), NA, 2022)) |>
  rename(Produksi22 = Produksi) |>
  left_join(stpim21 |> select(Kipb, Disic521, Produksi), by = c("kip" = "Kipb")) |>
  mutate(tahun21 = ifelse(is.na(Disic521), NA, 2021)) |>
  rename(Produksi21     = Produksi,
         produksi_dpa23 = b2r216) |>
  #Combine Disic5 dan Produksi
  mutate(Disic5         = ifelse(is.na(Disic522), Disic521, Disic522),
         produksi_stpim = ifelse(is.na(Produksi22), Produksi21, Produksi22),
         tahun          = ifelse(is.na(tahun22), tahun21, tahun22),
         kbli2_stpim    = substr(Disic5, 1, 2)) |>
  select(-Disic522, -Disic521, -Produksi22, -Produksi21, -tahun22, -tahun21)

#Filter STPIM non-TPT
cek_kbli <- target_imptpt_dpa23 |>
  filter(kbli2_stpim != 13 & kbli2_stpim != 14) |>
  select(kip, Disic5, b2r217, kbli2_stpim, kbli2_dpa23, produksi_stpim, produksi_dpa23, tahun) |>
  print()

#write_xlsx(cek_kbli, "cek_kbli.xlsx")

#KIP yang sudah dicek dan diindikasi non-TPT
cek_kbli_nontpt <- c(311390007, 311390456, 311510118, 311810306, 312210019, 321311729, 
                     321311804, 321311819, 321390608, 321391680, 321391771, 321412390, 
                     321510033, 321720004, 322100212, 322931973, 331020610, 331391969, 
                     332930002, 333100045, 341390020, 351310950, 351390042, 351390102, 
                     351390414, 351391068, 351391079, 351411144, 352220076, 361390162, 
                     321410652)

#Keluarkan perusahaan non-TPT
target_imptpt_dpa23 <- target_imptpt_dpa23 |>
  filter(!(kip %in% cek_kbli_nontpt))

#Update KBLI
target_imptpt_dpa23 <- target_imptpt_dpa23 |>
  #Update KBLI STPIM hasil pengecekan dengan KBLI DPA
  mutate(Disic5         = ifelse((kbli2_stpim != 13 & kbli2_stpim != 14), b2r217, Disic5),
         kbli2_stpim    = ifelse((kbli2_stpim != 13 & kbli2_stpim != 14), kbli2_dpa23, kbli2_stpim),
         produksi_stpim = ifelse((kbli2_stpim != 13 & kbli2_stpim != 14), produksi_dpa23, produksi_stpim)) |>
  #Imputasi KBLI untuk KIP tanpa histori dengan KBLI dari DPA23
  mutate(produksi_stpim = ifelse(is.na(kbli2_stpim), produksi_dpa23, produksi_stpim),
         Disic5         = ifelse(is.na(kbli2_stpim), b2r217, Disic5),
         kbli2_stpim    = ifelse(is.na(kbli2_stpim), kbli2_dpa23, kbli2_stpim))

```

Ada `r nrow(cek_kbli)` KIP dengan KBLI dari STPIM yang bukan TPT. Setelah dilakukan pengecekan, `r length(cek_kbli_nontpt)` KIP dieliminasi karena bukan industri TPT.

**Target imputasi dengan dasar DPA23 menjadi: `r nrow(target_imptpt_dpa23)` perusahaan.**


### Target imputasi dari SKIM23 TL dan irisan DPA23 TPT

```{r}
#Populasi TPT
total_tpt23 <- nrow(stpim23_tpt) + nrow(target_imptpt_dpa23) + nrow(skim23) - nrow(skim23_tl_nontpt)

#Total target imputasi 
total_imptpt <- nrow(skim23_tl_target) + nrow(target_imptpt_dpa23)

#Jadikan satu dataset target imputasi TPT
stpim_imptpt <- target_imptpt_dpa23 |>
  select(kip, tahun, prov, kab, Disic5, kbli2_stpim, produksi_stpim) |>
  rename(r201_kode = Disic5,
         kbli2     = kbli2_stpim,
         r202      = produksi_stpim) |>
  bind_rows(skim23_tl_target |>
              select(kip, tahun, prov, kab, r201_kode, r202, kbli2)) |>
  mutate(r202 = toupper(r202))

```

**Populasi usaha TPT 2023 (cakupan SKIM23) sebesar : `r total_tpt23`** (dengan rincian `r nrow(stpim23_tpt)` STPIM23 TPT + `r nrow(target_imptpt_dpa23)` Target Imputasi dasar DPA23 + `r nrow(skim23) - nrow(skim23_tl_nontpt)` SKIM23).

Total target imputasi sebanyak `r total_imptpt` perusahaan TPT.


# Imputasi tenaga kerja dan upah

```{r}
#Add variabel bulan operasi dan tk dari SKIM23 TL
stpim_imptpt <- stpim_imptpt |>
  left_join(skim23_tl_target |>
              select(kip, r203, r206a, r206b_1, r206b_2, r206c_1, r206c_2, r206d), by = "kip")

```


## Data historis STPIM22 dan STPIM21

```{r}
# irisan target imputasi dengan stpim22
stpim22_imptpt <- stpim22 |>
  filter(Kipb %in% stpim_imptpt$kip) 

# sisa target imputasi & tambahan informasi variabel tk, inves, omset dari dpa23
sisa_target22 <- stpim_imptpt |>
  filter(!(kip %in% stpim22_imptpt$Kipb)) 

# irisan target imputasi dengan stpim21
stpim21_imptpt <- stpim21 |>
  filter(Kipb %in% sisa_target22$kip)

# sisa target imputasi 
sisa_target21 <- sisa_target22 |>
  filter(!(kip %in% stpim21_imptpt$Kipb)) 

sisa_target21_dpa23 <- sisa_target21 |>
  filter(kip %in% dpa23$kip) |>
  left_join(dpa23 |>
              select(kip, b2r205, b2r210, b2r224, b2r225, b2r226, b2r218 ), by = "kip") 

sisa_target21_dpa24 <- sisa_target21 |>
  filter(!(kip %in% sisa_target21_dpa23$kip)) |>
  left_join(dpa24 |>
              select(kip, kondisi, unitkegiatan, tenagakerja, investasi, omset, statusmodal), by = "kip")

sisa_target21 <- sisa_target21_dpa23 |>
  bind_rows(sisa_target21_dpa24) |>
  mutate(kondisi      = ifelse(is.na(kondisi), b2r205, kondisi),
         unitkegiatan = ifelse(is.na(unitkegiatan), b2r210, unitkegiatan),
         tenagakerja  = ifelse(is.na(tenagakerja), b2r224, tenagakerja),
         investasi    = ifelse(is.na(investasi), b2r225, investasi),
         omset        = ifelse(is.na(omset), b2r226, omset),
         statusmodal  = ifelse(is.na(statusmodal), b2r218, statusmodal)) |>
  select(-b2r205, -b2r210, -b2r224, -b2r225, -b2r226, -b2r218)
  
```

Dari target imputasi TPT sebanyak **`r nrow(stpim_imptpt)`**, ditemukan irisan dengan data STPIM tahun-tahun sebelumnya sebagai sumber imputasi, a.l. sebanyak **`r nrow(stpim22_imptpt)` KIP dari STPIM22, `r nrow(stpim21_imptpt)` dari STPIM21**, sisanya `r nrow(sisa_target21)` KIP tidak ditemukan di STPIM21 dan STPIM22. Basis data STPIM20 tidak digunakan karena irisan yang tersisa tinggal KIP yang mayoritas berstatus nonrespon di STPIM20.

**`r nrow(sisa_target21)` KIP tanpa historis data STPIM akan diimputasi dengan tenaga kerja = 20** dengan pertimbangan bahwa skala usaha berdasarkan variabel tenaga kerja, investasi, dan omset di DPA23/DPA24-nya mayoritas adalah skala usaha mikro, kecil, dan menengah, serta sedikit usaha skala besar.


## Mapping variabel dan imputasi tenaga kerja dan upah

Langkah-langkah yang dilakukan di tahap ini:

- Mapping nama variabel STPIM21, STPIM22, SKIM23 (acuan variabel SKIM23).
- Mensinkronkan variabel STPIM21 dan STPIM22 sesuai dengan SKIM23.
- Melakukan imputasi tenaga kerja dengan tenaga kerja tahun sebelumnya serta mempertimbangkan isian dari SKIM23 TL.
- Melakukan imputasi upah dengan upah sebelumnya dengan adjustment rata-rata pertumbuhan UMP sebesar 7,5 persen  serta mempertimbangkan isian dari SKIM23 TL.
[Tautan sumber dasar imputasi - Klik di sini](https://www.suara.com/news/2023/01/01/190351/rincian-lengkap-ump-2023-yang-mulai-berlaku-1-januari)

```{r }
#menghapus tahun di nama variabel & rename var produksi
stpim22_imptpt <- stpim22_imptpt |>
  rename_with(~ gsub("22$", "", .)) |>
  rename(r202 = Produksi)

stpim21_imptpt <- stpim21_imptpt |>
  rename_with(~ gsub("21$", "", .)) |>
  rename(r202 = Produksi)

# Mapping nama variabel
var22 <- c("Kipb", "Dprovi", "Dkabup", "r202", "Year",
        # TK dan Upah
           "Lpmnop", "Lpmnon", "Lnmnop", "Lnmnon", #tk_laki
           "Lpwnop", "Lpwnon", "Lnwnop", "Lnwnon", #tk_perem
           "Lprnop", "Lprnon", #tk_prod
           "Lnpnop", "Lnpnon", #tk_lain
           "Ltlnof", #tk_asing
           "Zptvcu", "Zprvcu", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
           "Zntvcu", "Znrvcu", #pengpek_lain = upah_tklain + pengpeklain_tklain
           "Zpdvcu", #pengpek_prod
           "Zndvcu") #pengpek_lain
        
         # Komposisi Biaya INPUT
         #  "Rdnvcu", "Rimvcu", #bbakupen_dom #bbakupen_imp
         #   "Efuvcu", "Eplvcu", "Enpvcu", #bbakar #listrik_pln #listrik_nonpln


var21 <- c("Kipb", "Dprovi", "Dkabup", "r202", "Year",
        # TK dan Upah
           "Pwtlpi", "Pwtlpa", "Pwtlni", "Pwtlna", "Pttlpi", "Pttlpa", "Pttlni", "Pttlna",   #tk_laki
           "Pwtppi", "Pwtppa", "Pwtpni", "Pwtpna", "Pttppi", "Pttppa", "Pttpni", "Pttpna",   #tk_perem 
           "Ptdpri", "Ptdpra", "Ptdnpi", "Ptdnpa", #tk_takdibayar (dimasukkan ke tk_perem saja)
           "Lprnol", "Lprnof", #tk_prod
           "Lnpnol", "Lnpnof", #tk_lain
           "Lprnof", "Lnpnof", #tk_asing
           "Zptvcu", "Zpevcu", "Zphvcu", "Zprvcu", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
           "Zntvcu", "Znevcu", "Znhvcu", "Znrvcu", #pengpek_lain = upah_tklain + pengpeklain_tklain
           "Zpdvcu", #pengpek_prod
           "Zndvcu") #pengpek_lain
      
        # Komposisi Biaya INPUT
        #   "Rdnvcu", "Rimvcu", #bbakupen_dom #bbakupen_imp
        #   "Efuvcu", "Eplvcu", "Enpvcu", #bbakar #listrik_pln #listrik_nonpln


varskim23 <- c("kip", "prov", "kab", "r202", "r203i",
          # TK dan Upah
               "r206b_1i", #tk_laki
               "r206b_2i", #tk_perem
               "r206c_1i", #tk_prod
               "r206c_2i", #tk_lain
               "r206di", #tk_asing
               "r206ai", #total_tk
               "r301a_1i", "r301a_2i", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
               "r301b_3i", "r301b_4i", #pengpek_lain = upah_tklain + pengpeklain_tklain
               "r301ci" #total_upah
              )
          
          # Komposisi Biaya INPUT
          #      "r501k5_sum", "r501k7_sum", #bbakupen_dom #bbakupen_imp
          #       "r303a", "r304c", #bbakar #listrik
       

# Sync variabel dan nama var ke SKIM23 & Imputasi TK dan Pengeluaran Pekerja
stpim22_imptpt <- stpim22_imptpt |>
  mutate(r206b_1i = rowSums(across(c("Lpmnop", "Lpmnon", "Lnmnop", "Lnmnon")), na.rm = TRUE),  #tk_laki
         r206b_2i = rowSums(across(c("Lpwnop", "Lpwnon", "Lnwnop", "Lnwnon")), na.rm = TRUE), #tk_perem
         r206c_1i = rowSums(across(c("Lprnop", "Lprnon")), na.rm = TRUE), #tk_prod
         r206c_2i = rowSums(across(c("Lnpnop", "Lnpnon")), na.rm = TRUE), #tk_lain
         r206di   = Ltlnof, #tk_asing
         r206ai   = rowSums(across(c("r206b_1i", "r206b_2i")), na.rm = TRUE), #total_tk
         r301a_1i = 1.075 * Zptvcu, #upah_tkprod
         r301a_2i = 1.075 * Zprvcu, #pengpeklain_tkprod
         r301b_3i = 1.075 * Zntvcu, #upah_tklain
         r301b_4i = 1.075 * Znrvcu, #pengpeklain_tklain
         r301ci   = rowSums(across(c("r301a_1i", "r301a_2i", "r301b_3i", "r301b_4i")), na.rm = TRUE) #total_upah
         ) |>
  rename(kip       = Kipb,
         prov      = Dprovi,
         kab       = Dkabup,
         r203i      = Year)

stpim21_imptpt <- stpim21_imptpt |>
  mutate(r206b_1i = rowSums(across(c("Pwtlpi", "Pwtlpa", "Pwtlni", "Pwtlna", 
                                    "Pttlpi", "Pttlpa", "Pttlni", "Pttlna")), na.rm = TRUE),  #tk_laki
         r206b_2i = rowSums(across(c("Pwtppi", "Pwtppa", "Pwtpni", "Pwtpna", 
                                    "Pttppi", "Pttppa", "Pttpni", "Pttpna", 
                                    "Ptdpri", "Ptdpra", "Ptdnpi", "Ptdnpa")), na.rm = TRUE), #tk_perem
         r206c_1i = rowSums(across(c("Lprnol", "Lprnof")), na.rm = TRUE), #tk_prod
         r206c_2i = rowSums(across(c("Lnpnol", "Lnpnof")), na.rm = TRUE), #tk_lain
         r206di   = rowSums(across(c("Lprnof", "Lnpnof")), na.rm = TRUE), #tk_asing
         r206ai   = rowSums(across(c("r206b_1i", "r206b_2i")), na.rm = TRUE), #total_tk
         r301a_1i = 1.075 * Zptvcu, #upah_tkprod
         r301a_2i = 1.075 * rowSums(across(c("Zpevcu", "Zphvcu", "Zprvcu")), na.rm = TRUE), #pengpeklain_tkprod
         r301b_3i = 1.075 * Zntvcu, #upah_tklain
         r301b_4i = 1.075 * rowSums(across(c("Znevcu", "Znhvcu", "Znrvcu")), na.rm = TRUE), #pengpeklain_tklain
         r301ci   = rowSums(across(c("r301a_1i", "r301a_2i", "r301b_3i", "r301b_4i")), na.rm = TRUE) #total_upah
         ) |>
  rename(kip       = Kipb,
         prov      = Dprovi,
         kab       = Dkabup,
         r203i     = Year)

```

- Mengimputasi sisa KIP tanpa histori data dengan TK = 20, Upah = tk x 12 bulan operasional x UMP (asumsi UMP Jabar & Jateng 1,9juta)

```{r}
sisa_target21 <- sisa_target21 |>
  mutate(r203i    = 12,  #bulan operasi
         r206b_1i = 20,  #tk_laki
         r206b_2i =  0,  #tk_perem
         r206c_1i = 20,  #tk_prod
         r206c_2i =  0,  #tk_lain
         r206di   =  0, #tk_asing
         r206ai   = rowSums(across(c("r206b_1i", "r206b_2i")), na.rm = TRUE), #total_tk
         r301a_1i = r206b_1i * r203i * 1900, #upah_tkprod (asumsi: produksi 12 bulan, UMP Jabar Jateng ~1,9juta)
         r301a_2i =  0, #pengpeklain_tkprod
         r301b_3i =  0, #upah_tklain
         r301b_4i =  0, #pengpeklain_tklain
         r301ci   = rowSums(across(c("r301a_1i", "r301a_2i", "r301b_3i", "r301b_4i")), na.rm = TRUE), #total_upah
        )
```

- Menyatukan semua sumber data historis imputasi menjadi satu dataset.

```{r}
#Combine dataset STPIM22, STPIM21, dan no histori
imptpt_tk <- stpim22_imptpt |>
  select(all_of(varskim23)) |>
  bind_rows(select(stpim21_imptpt, all_of(varskim23))) |>
  bind_rows(select(sisa_target21, all_of(varskim23))) |>
  # Imputasi bulan operasi karena ada NA
  mutate(r203i = ifelse(is.na(r203i), median(r203i, na.rm = TRUE), r203i))

#Combine imputasi bulan operasi r203 dan tk r206 ke dataset utama
stpim_imptpt <- stpim_imptpt |>
  #modif kip tk tidak konsisten
  mutate(r206a = ifelse(kip == 321391986 | kip == 321312025, NA, r206a)) |>
  left_join(imptpt_tk |>
              select(kip, r203i, r206ai, r206b_1i, r206b_2i, r206c_1i, r206c_2i, r206di,
                     r301a_1i, r301a_2i, r301b_3i, r301b_4i, r301ci), by = "kip") |>
  mutate(r203    = ifelse(r203 == 0 | is.na(r203), r203i, r203),
         r206b_1 = ifelse(r206a == 0 | is.na(r206a), r206b_1i, r206b_1),
         r206b_2 = ifelse(r206a == 0 | is.na(r206a), r206b_2i, r206b_2),
         r206c_1 = ifelse(r206a == 0 | is.na(r206a), r206c_1i, r206c_1),
         r206c_2 = ifelse(r206a == 0 | is.na(r206a), r206c_2i, r206c_2),
         r206d   = ifelse(r206a == 0 | is.na(r206a), r206di, r206d),
         r206a   = ifelse(r206a == 0 | is.na(r206a), r206ai, r206a)) |>
  mutate(cek_r206a = r206a - rowSums(across(c(r206b_1, r206b_2)), na.rm = TRUE)) |>
  select(-r206ai, -r203i, -r206b_1i, -r206b_2i, -r206c_1i, -r206c_2i, -r206di, -cek_r206a)

```


## Perbaikan konsistensi upah

- Mengecek konsistensi upah dengan tenaga kerja. Kemudian melakukan perbaikan isian upah untuk KIP dengan isian upah dan tenaga kerja tidak konsisten.


### Perbaikan konsistensi upah hasil imputasi dari STPIM22 dan STPIM21

```{r}
#Cek apakah imputasi upah konsisten dengan total tk
cek_upah <- stpim_imptpt |>
  mutate(cek_upahprod = ifelse((r301a_1i > 0 & r206c_1 > 0), "ok", "inkonsisten"),
         cek_upahlain = ifelse((r301b_3i > 0 & r206c_2 > 0), "ok", "inkonsisten"),
         cek_upah     = ifelse((cek_upahprod == "ok" & cek_upahlain == "ok"), "ok", "inkonsisten")) |>
  #perbaikan konsistensi
  mutate(r301a_1i = ifelse((cek_upahprod == "ok" & (cek_upahlain != "ok" | is.na(cek_upahlain))),
                           r206c_1/r206a*r301ci, r301a_1i),
         r301a_2i = ifelse((cek_upahprod == "ok" & (cek_upahlain != "ok" | is.na(cek_upahlain))),
                           0, r301a_2i),
         r301b_3i = ifelse((cek_upahprod == "ok" & (cek_upahlain != "ok" | is.na(cek_upahlain))),
                           r206c_2/r206a*r301ci, r301b_3i),
         r301b_4i = ifelse((cek_upahprod == "ok" & (cek_upahlain != "ok" | is.na(cek_upahlain)))
                           , 0, r301b_4i),
         r301ci = rowSums(across(c(r301a_1i, r301a_2i, r301b_3i, r301b_4i)), na.rm = TRUE)) |>
  select(-cek_upahprod, -cek_upahlain, -cek_upah)

```


### Perbaikan konsistensi upah dari isian SKIM23 TL

```{r}
#Cek apakah isian upah SKIM23 TL konsisten dengan total tk
cekskim23tl_upah <- stpim_imptpt |>
  left_join(skim23_tl_target |>
              select(kip, r301a_1, r301a_2, r301b_3, r301b_4, r301c), by = "kip") |>
  mutate(across(c(r301a_1, r301a_2, r301b_3, r301b_4, r301c), as.numeric),
         cek_upahprod = ifelse((r301a_1 > 0 & r206c_1 > 0), "ok", "inkonsisten"),
         cek_upahlain = ifelse((r301b_3 > 0 & r206c_2 > 0), "ok", "inkonsisten"),
         cek_upah     = ifelse((cek_upahprod == "ok" & cek_upahlain == "ok"), "ok", "inkonsisten")) |>
  #perbaikan konsistensi
  mutate(r301a_1im = ifelse((cek_upahprod == "ok" & (cek_upahlain != "ok" | is.na(cek_upahlain))),
                           r206c_1/r206a*r301c, r301a_1),
         r301a_2im = ifelse((cek_upahprod == "ok" & (cek_upahlain != "ok" | is.na(cek_upahlain))),
                           0, r301a_2),
         r301b_3im = ifelse((cek_upahprod == "ok" & (cek_upahlain != "ok" | is.na(cek_upahlain))),
                           r206c_2/r206a*r301c, r301b_3),
         r301b_4im = ifelse((cek_upahprod == "ok" & (cek_upahlain != "ok" | is.na(cek_upahlain)))
                           , 0, r301b_4),
         r301cim = rowSums(across(c(r301a_1im, r301a_2im, r301b_3im, r301b_4im)), na.rm = TRUE)) 

#format numerik
options(scipen = 999) 

```


## Perbaikan kewajaran upah

- Menyatukan dataset perbaikan konsistensi upah antara sumber STPIM dan SKIM23.
- Mengecek kewajaran upah per tenaga kerja per bulan operasi dengan range 400ribu - 40juta per bulan per tenaga kerja.

```{r}
cek_upah <- cek_upah |>
  left_join(cekskim23tl_upah |>
              select(kip, r301a_1im, r301a_2im, r301b_3im, r301b_4im, r301cim), by = "kip") |>
  #cek kewajaran data upah per tk per bulan: 400ribu - 40juta per bulan per tk
  mutate(cek_upahptki   = r301ci/r206a/r203,
         cek_upahptkim  = r301cim/r206a/r203,
         cek_wajarupahi = ifelse(cek_upahptki <= 400 | cek_upahptki >= 40000, "tidak wajar", "ok"),
         cek_wajarupahim = ifelse(cek_upahptkim <= 400 | cek_upahptkim >= 40000, "tidak wajar", "ok")) |>
  mutate(r301a_1imp       = ifelse(cek_wajarupahim == "ok", r301a_1im, r301a_1i),
         r301a_2imp       = ifelse(cek_wajarupahim == "ok", r301a_2im, r301a_2i),
         r301b_3imp       = ifelse(cek_wajarupahim == "ok", r301b_3im, r301b_3i),
         r301b_4imp       = ifelse(cek_wajarupahim == "ok", r301b_4im, r301b_4i),
         r301cimp         = ifelse(cek_wajarupahim == "ok", r301cim, r301ci),
         cek301cimp    = r301cimp - rowSums(across(c(r301a_1imp, r301a_2imp, r301b_3imp, r301b_4imp)), na.rm = TRUE),
         cekupahtkimp     = ifelse(cek_wajarupahim == "ok", cek_upahptkim, cek_upahptki),
         cek_wajarupahimp = ifelse(cek_wajarupahim == "ok", cek_wajarupahim, cek_wajarupahi)) |>
  #perbaikan kasus khusus indikasi kelebihan digit
  mutate(across(c(r301a_1imp, r301a_2imp, r301b_3imp, r301b_4imp, r301cimp, cekupahtkimp), 
              ~ case_when(
                kip == 321311184 ~ .x / 10,
                kip == 361390205 ~ .x / 1000,
                TRUE ~ .x
              )))

```


### Hasil imputasi tenaga kerja dan upah 

```{r}
#Menyatukan imputasi upah ke dataset utama
stpim_imptpt <- stpim_imptpt |>
  left_join(cek_upah |>
              select(kip, r301a_1imp, r301a_2imp, r301b_3imp, r301b_4imp, r301cimp), by = "kip") |>
  rename(r301a_1 = r301a_1imp,
         r301a_2 = r301a_2imp,
         r301b_3 = r301b_3imp,
         r301b_4 = r301b_4imp,
         r301c   = r301cimp) |>
  select(-r301a_1i, -r301a_2i, -r301b_3i, -r301b_4i, -r301ci)
  
print(stpim_imptpt)

```


# Imputasi komponen biaya input

Imputasi komponen biaya input dilakukan dengan pendekatan pertumbuhan komponen biaya input dari data tahun sebelumnya, dengan langkah-langkah sebagai berikut.

## Menghitung pertumbuhan biaya input sebagai adjustment imputasi

- Menghitung pertumbuhan biaya input 2022 terhadap 2021 per provinsi, per 2 digit KBLI, dan skala tenaga kerja. Variasi pertumbuhan biaya input pada KBLI 13 maupun 14 sangat heterogen antarprovinsi seperti yang ditunjukkan oleh Grafik di bawah.

```{r}
stpim22_tpt <- stpim22 |>
  mutate(kbli2 = substr(Disic522, 1, 2)) |>
  filter(kbli2 == 13 | kbli2 == 14) |>
  rowwise() |>  # Ensure operations are performed row-wise
  mutate(skala_tk = sum(Lprnop22, Lprnon22, Lnpnop22, Lnpnon22, na.rm = TRUE)) |> 
  mutate(skala_tk = ifelse(skala_tk > 99, "B", "S")) |> 
  ungroup()  # Remove row-wise grouping for further operations

stpim21_tpt <- stpim21 |>
  mutate(kbli2 = substr(Disic521, 1, 2)) |>
  filter(kbli2 == 13 | kbli2 == 14) |>
  rowwise() |>  # Ensure operations are performed row-wise
  mutate(skala_tk = sum(Lprnol21, Lprnof21, Lnpnol21, Lnpnof21, na.rm = TRUE)) |> 
  mutate(skala_tk = ifelse(skala_tk > 99, "B", "S")) |> 
  ungroup()  # Remove row-wise grouping for further operations


#Mengelompokkan berdasarkan provinsi dan kbli2 
sum_inp22 <- stpim22_tpt |>
  group_by(Dprovi22, kbli2, skala_tk) |>
  summarise(total_inp22 = sum(Iinput22, na.rm = TRUE), 
            mean_inp22  = mean(Iinput22, na.rm = TRUE),        #mean input untuk imputasi observasi yang no histori
            .groups = "drop") |>
  mutate(prov_kbli2_skala = paste(Dprovi22, kbli2, skala_tk, sep = ""))

sum_inp21 <- stpim21_tpt |>
  group_by(Dprovi21, kbli2, skala_tk) |>
  summarise(total_inp21 = sum(Iinput21, na.rm = TRUE), .groups = "drop") |>
  mutate(prov_kbli2_skala = paste(Dprovi21, kbli2, skala_tk, sep = ""))


#Menghitung pertumbuhan biaya input per provinsi dan kbli2
sum_inp21 <- sum_inp21 |>
  left_join(sum_inp22[,c("prov_kbli2_skala", "total_inp22")], by = "prov_kbli2_skala") |>
  mutate(
    grwt_inp = ifelse(
      !is.na(total_inp21) & !is.na(total_inp22), 
      (total_inp22 - total_inp21) / total_inp21 * 100, 
      NA_real_
    )
  ) |>
  arrange(grwt_inp)

```

```{r}
#Filter data 
sum_inp21_13 <- sum_inp21 |>
  filter(kbli2 == 13) |>
  filter(!(is.na(grwt_inp)))
         
sum_inp21_14 <- sum_inp21 |>
  filter(kbli2 == 14) |>
  filter(!(is.na(grwt_inp)))
         

#Barplot pertumbuhan input KBLI 13
ggplot(sum_inp21_13, aes(x = reorder(Dprovi21, grwt_inp), y = grwt_inp)) +
  geom_bar(aes(fill = skala_tk), stat = "identity") +  # Fill color based on skala
  geom_text(aes(label = round(grwt_inp, 0)),  
            hjust = -0.1, 
            size = 3.5,
            colour = "gray") +  
  scale_fill_manual(values = c("B" = "navy", "S" = "maroon")) +  # Custom colors
  labs(title = "Pertumbuhan Input KBLI 13 per Provinsi (%)",
       x = "Provinsi",
       y = "Pertumbuhan (%)") +
  theme_minimal() +
  coord_flip()  # Flip for readability


#Barplot pertumbuhan input KBLI 14
ggplot(sum_inp21_14, aes(x = reorder(Dprovi21, grwt_inp), y = grwt_inp)) +
  geom_bar(aes(fill = skala_tk), stat = "identity") +  # Fill color based on skala
  geom_text(aes(label = round(grwt_inp, 0)),  
            hjust = -0.1, 
            size = 3.5,
            colour = "gray") +  
  scale_fill_manual(values = c("B" = "navy", "S" = "maroon")) +  # Custom colors
  labs(title = "Pertumbuhan Input KBLI 14 per Provinsi (%)",
       x = "Provinsi",
       y = "Pertumbuhan (%)") +
  theme_minimal() +
  coord_flip()  # Flip for readability


```

- Setelah didapatkan data histori pertumbuhan input 2022 terhadap 2021, match-kan dengan provinsi dan KBLI target imputasi 2023. 
- Jika ada yang tidak memiliki pertumbuhan input dikarenakan tidak adanya data histori, maka pendekatan dilakukan dengan melakukan imputasi pertumbuhan dengan median pertumbuhan seluruh observasi per provinsi kbli2 skala.
- Jika pertumbuhan biaya input terlalu ekstrem (kurang dari -40 persen s.d. lebih dari 400 persen), lakukan penyesuaian dengan men-setting range menjadi [-40 persen, 400 persen] (Pertimbangan: Provinsi Jateng pertumbuhannya -39 persen, sehingga ditetapkan -40 persen sebagai batas agar dapat mempertahankan fenomena TPT di provinsi dominan TPT).

```{r}
#Match pertumbuhan per provinsi, KBLI, dan skala dari data historis dengan target imputasi 2023
tab_stpim_imptpt <- stpim_imptpt |>
  mutate(skala_tk = ifelse(r206a > 99, "B", "S")) |> 
  group_by(prov, kbli2, skala_tk) |>
  summarise(total_nimp = n(), .groups = "drop") |>
  mutate(prov_kbli2_skala = paste(prov, kbli2, skala_tk, sep = "")) |>
  left_join(sum_inp21[, c("prov_kbli2_skala", "grwt_inp")], by = "prov_kbli2_skala") |>
  # Adjustment for no history data
  mutate(grwt_inp_imp = ifelse(is.na(grwt_inp), median(grwt_inp, na.rm = TRUE), grwt_inp)) |>  
  # Adjustment for outlier growth
  mutate(grwt_inp_imp = ifelse(grwt_inp_imp <= -40, -40, grwt_inp_imp)) |>
  mutate(grwt_inp_imp = ifelse(grwt_inp_imp >= 400, 400, grwt_inp_imp))

```

## Mengimputasi komposisi biaya input

- Melakukan imputasi komposisi biaya input dengan adjustment pertumbuhan biaya input 22-21 per KBLI2 per prov. Komponen biaya input yang diimputasi hanya terbatas, a.l. bahan baku dan penolong, bahan bakar, dan listrik.

```{r}
var2221_inp <- c("kip",
                 "Rdnvcu", "Rimvcu",                #bbakupen_dom #bbakupen_imp
                 "Efuvcu", "Eplvcu", "Enpvcu"       #bbakar #listrik_pln #listrik_nonpln
                 )     

stpim_imptpt_input <- stpim_imptpt |> 
  #combine data historis input 2022 dan 2021 jadi satu dataset
  left_join(
    bind_rows(
      stpim22_imptpt[var2221_inp] |> mutate(tahun = 2022),
      stpim21_imptpt[var2221_inp] |> mutate(tahun = 2021)
    )[var2221_inp], 
    by = "kip") |>
  mutate(skala_tk = ifelse(r206a > 99, "B", "S"),
         prov_kbli2_skala = paste(prov, kbli2, skala_tk, sep = "")) |>
  left_join(tab_stpim_imptpt[, c("prov_kbli2_skala", "grwt_inp_imp")], by = "prov_kbli2_skala") |>
  #adjust dengan growth
  mutate(r501k5_sum = Rdnvcu * ((100 + grwt_inp_imp) / 100),              #bbakupen_dom
         r501k7_sum = Rimvcu * ((100 + grwt_inp_imp) / 100),              #bbakupen_imp
         r303a      = Efuvcu * ((100 + grwt_inp_imp) / 100),              #bbakar
         r304c      = (Eplvcu + Enpvcu) * ((100 + grwt_inp_imp) / 100),   #listrik
         cektotal_input  = r501k5_sum + r501k7_sum + r303a + r304c
  ) |>
  select(tahun, kip, prov, kab, kbli2, skala_tk, prov_kbli2_skala, 
         grwt_inp_imp, r501k5_sum, r501k7_sum, r303a, r304c, cektotal_input)

```

- Imputasi no data histori (termasuk jika ada yang memiliki data histori tetapi total input 0): imputasi dilakukan dengan menggunakan nilai rata-rata input tahun 2022 menurut provinsi, kbli2, dan skala tk.

```{r}
#Match rata-rata input per provinsi, KBLI, dan skala dari data historis dengan target imputasi 2023
tab_stpim_imptpt <- tab_stpim_imptpt |>
  left_join(sum_inp22[, c("prov_kbli2_skala", "mean_inp22")], by = "prov_kbli2_skala") |>
  # Adjustment untuk observasi yang tidak punya history data dengan nilai persentil-25 (professional justification) 
  # karena hanya ada 1 observasi NA dari provinsi Aceh
  mutate(mean_inp22_imp = ifelse(is.na(mean_inp22), quantile(mean_inp22, probs = 0.25, na.rm = TRUE), mean_inp22))
  
#Ceplokan ke dataset stpim_imptpt_input
stpim_imptpt_input <- stpim_imptpt_input |>
  left_join(tab_stpim_imptpt |> 
              select(prov_kbli2_skala, mean_inp22_imp), by = "prov_kbli2_skala") |>
  mutate(r501k5_sum = ifelse((is.na(cektotal_input) | cektotal_input == 0), mean_inp22_imp, r501k5_sum)) |>
  mutate(across(c(r501k5_sum, r501k7_sum, r303a, r304c), ~ replace_na(.x, 0)),
         input  = r501k5_sum + r501k7_sum + r303a + r304c)

#Jadikan satu dengan main dataset
stpim_imptpt <- stpim_imptpt |>
  left_join(stpim_imptpt_input |> 
              select(kip, r501k5_sum, r501k7_sum, r303a, r304c, input), by = "kip")
  
```

# Imputasi output

Imputasi output dilakukan dengan machine learning dengan langkah:

- Training data dan menentukan model
- Imputasi data output dengan model terpilih

## Data preparation

Data yang digunakan untuk data training adalah data 2022. 
Sementara variabel yang digunakan untuk mengestimasi output a.l.: provinsi, kbli2, bulan operasi, tenaga kerja, upah, dan input.

```{r}
# Menyiapkan data 2022 sebagai data dasar untuk modeling
stpim22_tpt_ml <- stpim22_tpt |>
  select(Kipb, Dprovi22, Disic522, Year, Output22, Iinput22, 
         Lprnop22, Lprnon22, Lnpnop22, Lnpnon22, 
         Zptvcu22, Zprvcu22, Zntvcu22, Znrvcu22) |>
  mutate(kbli2       = substr(Disic522, 1, 2),
         r206a       = rowSums(across(c("Lprnop22", "Lprnon22",                       #tk_prod
                                        "Lnpnop22", "Lnpnon22")), na.rm = TRUE),      #tk_lain
         r301c       = rowSums(across(c("Zptvcu22", "Zprvcu22",       
                                        #pengpek_prod = upah_tkprod + pengpeklain_tkprod
                                        "Zntvcu22", "Znrvcu22")))) |> 
                                        #pengpek_lain = upah_tklain + pengpeklain_tklain
  rename(kip    = Kipb,
         prov   = Dprovi22,
         r203   = Year,
         output = Output22,
         input  = Iinput22) |>
  select(kip, prov, kbli2, r203, r206a, r301c, output, input)

# Cleaning data karena masih ada data tidak wajar: input 0
stpim22_tpt_ml <- stpim22_tpt_ml |>
  filter(input > 0)

# Melihat pola data >> menyingkirkan outlier
ggplot(stpim22_tpt_ml, aes(x = input, y = output, color = as.factor(kbli2))) +
  geom_point(alpha = 0.7) +  # Scatter points with transparency
  labs(
    title = "Scatter Plot of Output vs Input by KBLI2",
    x = "Input",
    y = "Output",
    color = "KBLI2"
  ) +
  theme_minimal()

```

Terlihat sebaran data masih ada outlier di mana input sangat kecil, tetapi output sangat tinggi. 

Catatan: Setelah dicek, KIP 331411444 (titik biru pojok kiri atas) merupakan perusahaan maklun di mana nilai input berasal dari listrik dan lainnya, tanpa nilai bahan baku.

## Data split 

Dataset 2022 dibagi menjadi 2 : training (80 persen) dan testing (20 persen).

```{r, warning = FALSE}
# Split data training and testing
set.seed(888)
trainIndex <- createDataPartition(stpim22_tpt_ml$output, p = 0.8, list = FALSE, times = 1)

train_data <- stpim22_tpt_ml[trainIndex,] |>
  select(-kip)
validation_data  <- stpim22_tpt_ml[-trainIndex,] |>
  select(-kip)

```

## Data training 

Data training dilakukan dengan 2 model: K-Nearest Neighbour (KNN) dan random forest (RF). Melalui training data, didapatkan model RF dapat mengestimasi lebih baik dibandingkan KNN. Hal ini ditunjukkan oleh nilai RMSE yang lebih rendah. Meski demikian, model KNN akan tetap digunakan sebagai model alternatif untuk mengatasi kasus tertentu yang tidak dapat diatasi dengan model RF.

```{r}
# Model KNN
set.seed(6789)
knn_fit <- train(output ~ . ,
                 data = train_data,
                 method = "knn",
                 preProc = c("center", "scale"), #standardize
                 # Decide k parameter!
                 tuneGrid		= data.frame(.k = seq(from = 1, to = (ncol(train_data) - 1), by = 1)),  
                 trControl		= trainControl(method = "cv")
                 )
knn_fit
plot(knn_fit)

knn_preds <- predict(knn_fit, validation_data)
rmse(actual = validation_data$output, predicted = knn_preds)


# Model RF
set.seed(6789)
rf_fit <- train(output ~ . ,
                data = train_data,
                method = "rf",
                tuneGrid		= data.frame(mtry = seq(from = 1, to = (ncol(train_data) - 1), by = 1)),
                ntree = 100,   # Decide ntree!!
                importance	= TRUE,
                trControl		= trainControl(method = "cv")
                )
rf_fit

rf_preds <- predict(rf_fit, validation_data)
rmse(actual = validation_data$output, predicted = rf_preds)

```

## Output imputation

- Menyiapkan data 2023 untuk imputasi.

Setelah mencoba untuk mengimputasi output menggunakan model yang telah di-training, muncul isu tidak adanya data dasar kbli 13 di provinsi 11 pada data training. Solusi, imputasi 1 observasi di provinsi 11 didekati dengan provinsi dengan karakteristik industri tekstil yang serupa (tenaga kerja mikro) yaitu provinsi 13.

```{r}
# Modifikasi data agar dapat diterapkan model machine learning
stpim_imptpt_output <- stpim_imptpt |>
  select(kip, prov, kbli2, r203, r206a, r301c, input) |>
  mutate(prov = ifelse(prov == 11, 13, prov)) 

```

- Mengimputasi data dengan model yang telah ditraining (machine learning).
- Mengecek nilai tambah.

Ada kasus di mana imputasi dengan model RF menghasilkan nilai tambah negatif. Maka dari itu, adjustment dilakukan dengan menggunakan model alternatif KNN untuk perusahaan yang nilai tambahnya negatif dengan model RF.

- Mengecek kewajaran nilai tambah dan upah.

Ditemukan kasus di mana nilai tambah lebih kecil daripada upah. Maka dari itu, adjustment dilakukan dengan imputasi menggunakan rasio rata-rata output (dari hasil machine learning), tenaga kerja, dan input.

```{r}
# Imputasi output 2023
stpim_imptpt_output <- stpim_imptpt_output |>
  mutate(output_knn = predict(knn_fit, stpim_imptpt_output),
         ntb_knn    = output_knn - input,
         output_rf  = predict(rf_fit, stpim_imptpt_output),
         ntb_rf     = output_rf - input) |>
  #replace ntb_rf negatif dengan ntb_knn positif
  mutate(output = ifelse(ntb_rf < 0, output_knn, output_rf),
         ntb    = output - input) |>
  #cek ntb dengan upah 
  mutate(cek_ntbupah = ntb - r301c) |>
  # >> masih ada yang ntb<upah
  #ambil max output untuk ntb<upah 
  mutate(output = ifelse((cek_ntbupah < 0), pmax(output_knn, output_rf), output)) |>
  mutate(ntb    = output - input,
         cek_ntbupah = ntb - r301c)
  #>> masih ada yang ntb<upah

#menghitung rata-rata tk, input, dan output data estimasi hasil machine learning
stpim_imptpt_output_rasio <- stpim_imptpt_output |>
  filter(cek_ntbupah > 0) |>
  group_by(kbli2, prov) |>
  summarise(avg_tk     = mean(r206a, na.rm = TRUE),
            avg_input  = mean(input, na.rm = TRUE),
            avg_output = mean(output, na.rm = TRUE))

#mengecek kewajaran observasi yang ntb<upah
stpim_imptpt_output_nonwjr <- stpim_imptpt_output |>
  filter(cek_ntbupah < 0) |>
  left_join(stpim_imptpt_output_rasio, by = c("prov", "kbli2")) |>
  #coba rasio output-tk
  mutate(output_rasio = avg_output/avg_tk * r206a,
         ntb_rasio    = output_rasio - input,
         cek_ntbupah  = ntb_rasio - r301c) |>
  #>> masih ada yang ntb negatif dan ntb<upah, maka adjustment rasio dari rasio output-input
  mutate(output_rasio = avg_output/avg_input * input,
         ntb_rasio    = output_rasio - input,
         cek_ntbupah  = ntb_rasio - r301c)

#Jadikan satu ke dataset output
stpim_imptpt_output <- stpim_imptpt_output |>
  left_join(stpim_imptpt_output_nonwjr |> 
              select(kip, output_rasio), by = "kip") |>
  mutate(output      = ifelse(cek_ntbupah < 0, output_rasio, output),
         ntb         = output - input,
         cek_ntbupah = ntb - r301c) |>
  select(-output_rasio)

```

- Mengkompile data imputasi final

Data final imputasi sudah didapatkan namun dengan beberapa catatan, a.l:
- Nama komoditas produksi (r504a) ada yang belum terisi karena tidak adanya data historis. 
- Ada beberapa nama komoditas yang tidak relevan dengan TPT perlu pengecekan lebih lanjut.

```{r}
#Jadikan satu dengan main dataset
skim23_imptpt <- stpim_imptpt |>
  left_join(stpim_imptpt_output |> 
              select(kip, output, ntb), by = "kip") |>
  #menyesuaikan nama variabel dengan SKIM23
  rename(r503k6_sum = output) |>
  #menambah variabel klasifikasi skim23 tl
  mutate(skim23_tl = ifelse(tahun == 2024, "SKIM23 TL", NA))


write_xlsx(skim23_imptpt, "skim23_imptpt.xlsx")

```






