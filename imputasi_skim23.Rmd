---
title: "Imputasi SKIM23"
author: "Ayu Paramudita"
output:
  html_document:
    toc: true
    toc_depth: 2
code-fold: true
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(dplyr)
library(knitr)
```


# Investigasi target imputasi

## Load data

```{r, warning=FALSE}
dpa23   <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/DPA NASIONAL tahun 2023.xlsx")
skim23  <- read_xlsx("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/SKIM.IIADetail NASIONAL tahun 2024.xlsx")

stpim23 <- read_xlsx("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/STPIM (CAWI) NASIONAL tahun 2024.xlsx")
weight23 <- read.csv2("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/2024-12-23 10_02_52 Weight STPIM 2024(Sheet1).csv")

```


## Data DPA23 TPT

```{r }
dpa23_tpt <- dpa23 |>
  mutate(kbli2_dpa23 = substr(b2r217, 1, 2)) |>
  filter(b2r205 == 1,                            # kondisi aktif
         b2r210 != 4,                            # bukan kantor pusat
         kbli2_dpa23 == 13 | kbli2_dpa23 == 14              # kbli 13 dan 14
         ) |>
  select(kip, prov, kab, b2r217, kbli2_dpa23, b2r205, b2r210, b2r224, b2r225, b2r226, b2r218)

# Buat tabel
tab_dpa23tpt <- table(dpa23_tpt$kbli2_dpa23)
tab_dpa23tpt <- as.data.frame(tab_dpa23tpt) |>
  rename(KBLI = Var1,
         N    = Freq) 

total_dpatpt23 <- data.frame(KBLI = "Total", N = sum(tab_dpa23tpt$N))
tab_dpa23tpt <- rbind(tab_dpa23tpt, total_dpatpt23)
tab_dpa23tpt <- kable(tab_dpa23tpt)

```

Referensi **target usaha awal**: DPA23 kondisi 1 (aktif), KBLI 13-14, dan selain kantor pusat. *Kenapa **target usaha awal**? Karena nanti di akhir setelah imputasi akan dicek kembali (range tenaga kerja, investasi, omset, badan usaha/hukum, dll dari DPA23) mana yang layak masuk sebagai mfg/data final.*

Jumlah target usaha TPT (KBLI 13 & 14) menurut DPA23: **`r nrow(dpa23_tpt)`**. 

Dengan rincian sebagai berikut: `r tab_dpa23tpt`.


## Cek SKIM23

```{r }
skim23 <- skim23 |>
  mutate(kbli2 = substr(r201_kode, 1, 2))

# Buat tabel
tab_skim23 <- table(skim23$kbli2)
tab_skim23 <- as.data.frame(tab_skim23) |>
  rename(KBLI = Var1,
         N    = Freq) 

total_skim23 <- data.frame(KBLI = "Total", N = sum(tab_skim23$N))
tab_skim23 <- rbind(tab_skim23, total_skim23)
tab_skim23 <- kable(tab_skim23)

nkbli_na <- sum(is.na(skim23$kbli2))   

```

Jumlah perusahaan TPT di SKIM23 : **`r nrow(skim23)`**

`r tab_skim23`

**KBLI yang NA : `r nkbli_na`**


## Target usaha SKIM yang perlu imputasi dengan dasar jumlah usaha dari DPA23 TPT

```{r }
target_imptpt <- dpa23_tpt |>
  filter(!(kip %in% skim23$kip))

```

**Target imputasi TPT: `r nrow(target_imptpt)`.**


## Cek DPA23 TPT dengan weight STPIM23

Catatan: weight STPIM23 adalah dokumen berisi list KIP usaha STPIM23 dan penimbangnya.

```{r}
# Cek irisan DPA23 TPT dan weight STPIM23
cek_dpa23tpt_weight <- dpa23_tpt |>
  filter((kip %in% weight23$kipb))

```

Tidak ada irisan DPA23 TPT dengan weight: aman.
Sehingga, target imputasi TPT **`r nrow(target_imptpt)`**.


## Cek STPIM23 TPT dan weight STPIM23

```{r, results='hide'}
# Cek usaha TPT di STPIM23
stpim23_tpt <- stpim23 |>
  mutate(kbli2 = substr(r201_kode, 1, 2)) |>
  filter(kbli2 == 13 | kbli2 == 14)

list_stpim23_tpt <- print(stpim23_tpt$kip)

total_tpt23 <- nrow(stpim23_tpt) + nrow(target_imptpt) + nrow(skim23)
```

Ternyata masih ada `r nrow(stpim23_tpt)` usaha TPT yang dicatat di STPIM23. 
Apakah `r nrow(stpim23_tpt)` usaha 13-14 STPIM23 ini ada di weight?

```{r}
# Cek irisan STPIM23 dan weight
cek_stpim23tpt_weight <- stpim23_tpt |>
  filter((kip %in% weight23$kipb))

```

Ada `r nrow(cek_stpim23tpt_weight)` usaha 13-14 yang ada di weight. Maka, dokumen weight harus diupdate dengan mengeluarkan 3 usaha 13-14 ini. KIP `r nrow(cek_stpim23tpt_weight)` perusahaan tersebut a.l.: `r cek_stpim23tpt_weight$kip`.

**`r nrow(stpim23_tpt)` usaha 13-14 STPIM23 harus masuk menjadi cakupan SKIM23**. *Jangan lupa untuk dimasukkan saat mengkompilasi data SKIM23 untuk tabulasi nanti*. KIP `r nrow(stpim23_tpt)` perusahaan tersebut a.l.:

`r list_stpim23_tpt`

**Sehingga populasi usaha TPT 2023 (cakupan SKIM23) sebesar : `r total_tpt23`** (`r nrow(stpim23_tpt)` STPIM23 TPT + `r nrow(target_imptpt)` Target Imputasi + `r nrow(skim23)` SKIM23).


# IMPUTASI

## Load data sumber imputasi

```{r, warning=FALSE}
stpim22 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg22.xlsx")
stpim21 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg21e.xlsx")
#stpim20 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg20f.xlsx")

stpim22 <- stpim22 |>
  mutate(kbli2_stpim = substr(Disic522, 1, 2))
```

## Cek irisan target imputasi dengan STPIM22, STPIM21, dan STPIM20

Cek irisan ini bertujuan untuk mendapatkan basis data dari data historis masing-masing KIP yang ingin diimputasi.

```{r }
# irisan target imputasi dengan stpim22
stpim22_imptpt <- stpim22 |>
  filter(Kipb %in% target_imptpt$kip) 

# sisa target imputasi & tambahan informasi variabel tk, inves, omset dari dpa23
sisa_target22 <- target_imptpt |>
  filter(!(kip %in% stpim22_imptpt$Kipb)) |>
  left_join(dpa23, by = "kip") |>
  select(kip, prov.x, kab.x, b2r217.x, kbli2_dpa23, b2r205.x, b2r210.x, b2r224.x, b2r225.x, b2r226.x, b2r218.x) |>
  rename(prov = prov.x,
         kab  = kab.x,
         b2r217 = b2r217.x,
         b2r205 = b2r205.x,
         b2r210 = b2r210.x,
         b2r224 = b2r224.x,
         b2r225 = b2r225.x,
         b2r226 = b2r226.x,
         b2r218 = b2r218.x)

# irisan target imputasi dengan stpim21
stpim21_imptpt <- stpim21 |>
  filter(Kipb %in% sisa_target22$kip)

# sisa target imputasi 
sisa_target21 <- sisa_target22 |>
  filter(!(kip %in% stpim21_imptpt$Kipb))

```

Dari target imputasi TPT sebanyak **`r nrow(target_imptpt)`**, ditemukan irisan dengan data STPIM tahun-tahun sebelumnya sebagai sumber imputasi, a.l. sebanyak **`r nrow(stpim22_imptpt)` KIP dari STPIM22, `r nrow(stpim21_imptpt)` dari STPIM21**, sisanya `r nrow(sisa_target21)` KIP tidak ditemukan di STPIM21 dan STPIM22. Basis data STPIM20 tidak digunakan karena irisan yang tersisa tinggal KIP yang semuanya nonrespon di STPIM20.

**`r nrow(sisa_target21)` KIP tanpa historis data STPIM akan diimputasi dengan tenaga kerja = 20** dengan pertimbangan bahwa skala usaha berdasarkan variabel tenaga kerja, investasi, dan omset di DPA23nya masing-masing adalah skala usaha mikro dan kecil.

## Mapping variabel STPIM21 dan STPIM22 ke SKIM23

Langkah-langkah yang dilakukan di tahap ini:

- Mapping nama variabel STPIM21, STPIM22, SKIM23.
- Mensinkronkan variabel STPIM21 dan STPIM22 sesuai dengan SKIM23.

```{r }
#menghapus tahun di nama variabel
stpim22_imptpt <- stpim22_imptpt |>
  rename_with(~ gsub("22$", "", .))

stpim21_imptpt <- stpim21_imptpt |>
  rename_with(~ gsub("21$", "", .))

# Mapping nama variabel
var22 <- c("Kipb", "Dprovi", "Dkabup", "Disic5", "Year",
  "Lpmnop", "Lpmnon", "Lnmnop", "Lnmnon", #tk_laki
  "Lpwnop", "Lpwnon", "Lnwnop", "Lnwnon", #tk_perem
  "Lprnop", "Lprnon", #tk_prod
  "Lnpnop", "Lnpnon", #tk_lain
  "Ltlnof", #tk_asing
  "Zptvcu", "Zprvcu", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
  "Zntvcu", "Znrvcu", #pengpek_lain = upah_tklain + pengpeklain_tklain
  "Zpdvcu", #pengpek_prod
  "Zndvcu" #pengpek_lain
  )

var21 <- c("Kipb", "Dprovi", "Dkabup", "Disic5", "Year",
           "Pwtlpi", "Pwtlpa", "Pwtlni", "Pwtlna", "Pttlpi", "Pttlpa", "Pttlni", "Pttlna",   #tk_laki
           "Pwtppi", "Pwtppa", "Pwtpni", "Pwtpna", "Pttppi", "Pttppa", "Pttpni", "Pttpna",   #tk_perem 
           "Ptdpri", "Ptdpra", "Ptdnpi", "Ptdnpa", #tk_takdibayar (dimasukkan ke tk_perem saja)
           "Lprnol", "Lprnof", #tk_prod
           "Lnpnol", "Lnpnof", #tk_lain
           "Lprnof", "Lnpnof", #tk_asing
           "Zptvcu", "Zpevcu", "Zphvcu", "Zprvcu", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
           "Zntvcu", "Znevcu", "Znhvcu", "Znrvcu", #pengpek_lain = upah_tklain + pengpeklain_tklain
           "Zpdvcu", #pengpek_prod
           "Zndvcu" #pengpek_lain
           )

varskim23 <- c("tahun", "kip", "prov", "kab", "r201_kode", "r203", "Disic5", "b2r217",
               "r206b_1", #tk_laki
               "r206b_2", #tk_perem
               "r206c_1", #tk_prod
               "r206c_2", #tk_lain
               "r206d", #tk_asing
               "r206a", #total_tk
               "r301a_1", "r301a_2", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
               "r301b_1", "r301b_2", #pengpek_lain = upah_tklain + pengpeklain_tklain
               "r301c" #total_upah
               )

# Sync variabel dan nama var ke SKIM23
stpim22_imptpt <- stpim22_imptpt |>
  mutate(tahun   = 2022,
         r206b_1 = rowSums(across(c("Lpmnop", "Lpmnon", "Lnmnop", "Lnmnon")), na.rm = TRUE),  #tk_laki
         r206b_2 = rowSums(across(c("Lpwnop", "Lpwnon", "Lnwnop", "Lnwnon")), na.rm = TRUE), #tk_perem
         r206c_1 = rowSums(across(c("Lprnop", "Lprnon")), na.rm = TRUE), #tk_prod
         r206c_2 = rowSums(across(c("Lnpnop", "Lnpnon")), na.rm = TRUE), #tk_lain
         r206d   = Ltlnof, #tk_asing
         r206a   = rowSums(across(c("r206b_1", "r206b_2")), na.rm = TRUE), #total_tk
         r301a_1 = Zptvcu, #upah_tkprod
         r301a_2 = Zprvcu, #pengpeklain_tkprod
         r301b_1 = Zntvcu, #upah_tklain
         r301b_2 = Znrvcu, #pengpeklain_tklain
         r301c   = rowSums(across(c("r301a_1", "r301a_2", "r301b_1", "r301b_2")), na.rm = TRUE), #total_upah
         r201_kode = NA,
         b2r217    = NA
         ) |>
  rename(kip       = Kipb,
         prov      = Dprovi,
         kab       = Dkabup,
         r203      = Year)

stpim21_imptpt <- stpim21_imptpt |>
  mutate(tahun = 2021,
         r206b_1 = rowSums(across(c("Pwtlpi", "Pwtlpa", "Pwtlni", "Pwtlna", 
                                    "Pttlpi", "Pttlpa", "Pttlni", "Pttlna")), na.rm = TRUE),  #tk_laki
         r206b_2 = rowSums(across(c("Pwtppi", "Pwtppa", "Pwtpni", "Pwtpna", 
                                    "Pttppi", "Pttppa", "Pttpni", "Pttpna", 
                                    "Ptdpri", "Ptdpra", "Ptdnpi", "Ptdnpa")), na.rm = TRUE), #tk_perem
         r206c_1 = rowSums(across(c("Lprnol", "Lprnof")), na.rm = TRUE), #tk_prod
         r206c_2 = rowSums(across(c("Lnpnol", "Lnpnof")), na.rm = TRUE), #tk_lain
         r206d   = rowSums(across(c("Lprnof", "Lnpnof")), na.rm = TRUE), #tk_asing
         r206a   = rowSums(across(c("r206b_1", "r206b_2")), na.rm = TRUE), #total_tk
         r301a_1 = Zptvcu, #upah_tkprod
         r301a_2 = rowSums(across(c("Zpevcu", "Zphvcu", "Zprvcu")), na.rm = TRUE), #pengpeklain_tkprod
         r301b_1 = Zntvcu, #upah_tklain
         r301b_2 = rowSums(across(c("Znevcu", "Znhvcu", "Znrvcu")), na.rm = TRUE), #pengpeklain_tklain
         r301c   = rowSums(across(c("r301a_1", "r301a_2", "r301b_1", "r301b_2")), na.rm = TRUE), #total_upah
         r201_kode = NA,
         b2r217    = NA
         ) |>
  rename(kip       = Kipb,
         prov      = Dprovi,
         kab       = Dkabup,
         r203      = Year)

```

- Mengimputasi sisa KIP tanpa histori data dengan TK = 20, Upah = tk x 12 bulan operasional x UMP (asumsi UMP Jabar & Jateng 1,9juta)

```{r}
sisa_target21 <- sisa_target21 |>
  mutate(tahun = 0000,
         r203    = 12,  #bulan operasi
         r206b_1 = 20,  #tk_laki
         r206b_2 =  0,  #tk_perem
         r206c_1 = 20,  #tk_prod
         r206c_2 =  0,  #tk_lain
         r206d   =  0, #tk_asing
         r206a   = rowSums(across(c("r206b_1", "r206b_2")), na.rm = TRUE), #total_tk
         r301a_1 = r206b_1 * r203 * 1900, #upah_tkprod (asumsi: produksi 12 bulan, UMP Jabar Jateng ~1,9juta)
         r301a_2 =  0, #pengpeklain_tkprod
         r301b_1 =  0, #upah_tklain
         r301b_2 =  0, #pengpeklain_tklain
         r301c   = rowSums(across(c("r301a_1", "r301a_2", "r301b_1", "r301b_2")), na.rm = TRUE), #total_upah
         r201_kode = NA,
         b2r217    = NA,
         Disic5    = NA
         )
```

- Menyatukan semua sumber data historis imputasi menjadi satu dataset.

```{r}
# Combine dataset STPIM22, STPIM21, dan no histori KIP
stpim_imptpt <- stpim22_imptpt |>
  select(all_of(varskim23)) |>
  bind_rows(select(stpim21_imptpt, all_of(varskim23))) |>
  bind_rows(select(sisa_target21, all_of(varskim23))) |>
  left_join(target_imptpt[c("kip", "b2r217")], by = "kip") |>
  select(-b2r217.x) |>
  rename(b2r217 = b2r217.y) |> 
  mutate(kbli2_dpa23 = substr(b2r217, 1, 2),
         kbli2_stpim = substr(Disic5, 1, 2))

```

- Cek apakah ada target yang memiliki historis STPIM yang KBLI-nya bukan TPT?

```{r}
cek_kbli <- stpim_imptpt |> 
  filter(kbli2_stpim != 13 & kbli2_stpim != 14) |>
  left_join(dpa23[c("kip", "b2r216")], by = "kip") |>
  left_join(stpim22[c("Kipb", "Produksi")], by = c("kip" = "Kipb")) |>
  rename(produksi_dpa23 = b2r216,
         produksi_stpim = Produksi)

list_cek_kbli <- cek_kbli |>
  select(tahun, kip, Disic5, b2r217, kbli2_stpim, kbli2_dpa23, produksi_stpim, produksi_dpa23) |>
  print()

#Note: ada beberapa KIP yang data historisnya bukan TPT >> cek satu-satu
#Ada `r nrow(cek_kbli)` KIP dengan KBLI dari STPIM yang bukan TPT, a.l.: 

#`r list_cek_kbli`

#Setelah dilakukan pengecekan, KIP berikut yang layak menjadi target TPT:

```


```{r}
target_imptpt

## variabel imputasi?
## model apa imputasi? rasio? ml?
## tk : historis 22
## pengeluaran pekerja : historis 22
## total output : rasio/ml?
## breakdown output : rasio komponen?
## biaya input?

```


