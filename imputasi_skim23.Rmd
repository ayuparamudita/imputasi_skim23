---
title: "Imputasi SKIM23"
author: "Ayu Paramudita"
output:
  html_document:
    toc: true
    toc_depth: 2
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(dplyr)
library(knitr)
```


# Investigasi target imputasi

## Load data

```{r, warning=FALSE}
dpa23   <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/DPA NASIONAL tahun 2023.xlsx")
skim23  <- read_xlsx("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/SKIM.IIADetail NASIONAL tahun 2024.xlsx")

stpim23 <- read_xlsx("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/STPIM (CAWI) NASIONAL tahun 2024.xlsx")
weight23 <- read.csv2("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/2024-12-23 10_02_52 Weight STPIM 2024(Sheet1).csv")

```


## Data DPA23 TPT

```{r }
dpa23_tpt <- dpa23 |>
  mutate(kbli2 = substr(b2r217, 1, 2)) |>
  filter(b2r205 == 1,                            # kondisi aktif
         b2r210 != 4,                            # bukan kantor pusat
         kbli2  == 13 | kbli2 == 14              # kbli 13 dan 14
         ) |>
  select(kip, prov, kbli2, b2r205, b2r210)

# Buat tabel
tab_dpa23tpt <- table(dpa23_tpt$kbli2)
tab_dpa23tpt <- as.data.frame(tab_dpa23tpt) |>
  rename(KBLI = Var1,
         N    = Freq) 

total_dpatpt23 <- data.frame(KBLI = "Total", N = sum(tab_dpa23tpt$N))
tab_dpa23tpt <- rbind(tab_dpa23tpt, total_dpatpt23)
tab_dpa23tpt <- kable(tab_dpa23tpt)

```

Referensi target usaha: DPA23 kondisi 1 (aktif), KBLI 13-14, dan selain kantor pusat.

Jumlah target usaha TPT (KBLI 13 & 14) menurut DPA23: **`r nrow(dpa23_tpt)`**. 

Dengan rincian sebagai berikut: `r tab_dpa23tpt`.


## Cek SKIM23

```{r }
skim23 <- skim23 |>
  mutate(kbli2 = substr(r201_kode, 1, 2))

# Buat tabel
tab_skim23 <- table(skim23$kbli2)
tab_skim23 <- as.data.frame(tab_skim23) |>
  rename(KBLI = Var1,
         N    = Freq) 

total_skim23 <- data.frame(KBLI = "Total", N = sum(tab_skim23$N))
tab_skim23 <- rbind(tab_skim23, total_skim23)
tab_skim23 <- kable(tab_skim23)

nkbli_na <- sum(is.na(skim23$kbli2))   

```

Jumlah perusahaan TPT di SKIM23 : **`r nrow(skim23)`**

`r tab_skim23`

**KBLI yang NA : `r nkbli_na`**


## Target usaha SKIM yang perlu imputasi dengan dasar jumlah usaha dari DPA23 TPT

```{r }
target_imptpt <- dpa23_tpt |>
  filter(!(kip %in% skim23$kip))

```

**Target imputasi TPT: `r nrow(target_imptpt)`.**


## Cek DPA23 TPT dengan weight STPIM23

Catatan: weight STPIM23 adalah dokumen berisi list KIP usaha STPIM23 dan penimbangnya.

```{r}
# Cek irisan DPA23 TPT dan weight STPIM23
cek_dpa23tpt_weight <- dpa23_tpt |>
  filter((kip %in% weight23$kipb))

```

Tidak ada irisan DPA23 TPT dengan weight: aman.
Sehingga, target imputasi TPT **`r nrow(target_imptpt)`**.


## Cek STPIM23 TPT dan weight STPIM23

```{r, results='hide'}
# Cek usaha TPT di STPIM23
stpim23_tpt <- stpim23 |>
  mutate(kbli2 = substr(r201_kode, 1, 2)) |>
  filter(kbli2 == 13 | kbli2 == 14)

list_stpim23_tpt <- print(stpim23_tpt$kip)

total_tpt23 <- nrow(stpim23_tpt) + nrow(target_imptpt) + nrow(skim23)
```

Ternyata masih ada `r nrow(stpim23_tpt)` usaha TPT yang dicatat di STPIM23. 
Apakah `r nrow(stpim23_tpt)` usaha 13-14 STPIM23 ini ada di weight?

```{r}
# Cek irisan STPIM23 dan weight
cek_stpim23tpt_weight <- stpim23_tpt |>
  filter((kip %in% weight23$kipb))

```

Ada `r nrow(cek_stpim23tpt_weight)` usaha 13-14 yang ada di weight. Maka, dokumen weight harus diupdate dengan mengeluarkan 3 usaha 13-14 ini. KIP `r nrow(cek_stpim23tpt_weight)` perusahaan tersebut a.l.: `r cek_stpim23tpt_weight$kip`.

**`r nrow(stpim23_tpt)` usaha 13-14 STPIM23 harus masuk menjadi cakupan SKIM23**. *Jangan lupa untuk dimasukkan saat mengkompilasi data SKIM23 untuk tabulasi nanti*. KIP `r nrow(stpim23_tpt)` perusahaan tersebut a.l.:

`r list_stpim23_tpt`

**Sehingga populasi usaha TPT 2023 (cakupan SKIM23) sebesar : `r total_tpt23`** (`r nrow(stpim23_tpt)` STPIM23 TPT + `r nrow(target_imptpt)` Target Imputasi + `r nrow(skim23)` SKIM23).


# IMPUTASI

## Load data sumber imputasi

```{r, warning=FALSE}
stpim22 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg22.xlsx")
stpim21 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg21e.xlsx")
stpim20 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg20f.xlsx")

stpim22 <- stpim22 |>
  mutate(kbli2 = substr(Disic522, 1, 2))
```

## Cek irisan target imputasi dengan STPIM22, STPIM21, dan STPIM20

Cek irisan ini bertujuan untuk mendapatkan basis data dari data historis masing-masing KIP yang ingin diimputasi.

```{r }
# irisan target imputasi dengan stpim22
stpim22_imptpt <- stpim22 |>
  filter(Kipb %in% target_imptpt$kip) 

# sisa target imputasi & tambahan informasi variabel tk, inves, omset dari dpa23
sisa_target22 <- target_imptpt |>
  filter(!(kip %in% stpim22_imptpt$Kipb)) |>
  left_join(dpa23, by = "kip") |>
  select(kip, prov.x, kbli2, b2r205.x, b2r210.x, b2r224, b2r225, b2r226) |>
  rename(prov = prov.x,
         b2r205 = b2r205.x,
         b2r210 = b2r210.x)

# irisan target imputasi dengan stpim21
stpim21_imptpt <- stpim21 |>
  filter(Kipb %in% sisa_target22$kip)

# sisa target imputasi 
sisa_target21 <- sisa_target22 |>
  filter(!(kip %in% stpim21_imptpt$Kipb))

```

Dari target imputasi TPT sebanyak **`r nrow(target_imptpt)`**, ditemukan irisan dengan data STPIM tahun-tahun sebelumnya sebagai sumber imputasi, a.l. sebanyak **`r nrow(stpim22_imptpt)` KIP dari STPIM22, `r nrow(stpim21_imptpt)` dari STPIM21, sisanya `r nrow(sisa_target21)` KIP tidak ditemukan di STPIM21 dan STPIM22. Basis data STPIM20 tidak digunakan karena irisan yang tersisa tinggal KIP yang nonrespon di STPIM20.

**`r nrow(sisa_target21)` KIP tanpa historis data STPIM akan diimputasi dengan tenaga kerja = 20** dengan pertimbangan bahwa skala usaha berdasarkan variabel tenaga kerja, investasi, dan omset di DPA23nya masing-masing adalah skala usaha mikro dan kecil.

```{r }
#menghapus tahun di nama variabel
stpim22_imptpt <- stpim22_imptpt |>
  rename_with(~ gsub("22$", "", .))

stpim21_imptpt <- stpim21_imptpt |>
  rename_with(~ gsub("21$", "", .))


var22 <- c("Kipb", "Dprovi", "Dkabup", "Disic5", "Year",
  "Lpmnop", "Lpmnon", "Lnmnop", "Lnmnon", #tk_laki
  "Lpwnop", "Lpwnon", "Lnwnop", "Lnwnon", #tk_perem
  "Lprnop", "Lprnon", #tk_prod
  "Lnpnop", "Lnpnon", #tk_lain
  "Ltlnof", #tk_asing
  "Zpdvcu", #pengpek_prod
  "Zndvcu" #pengpek_lain
  )

var21 <- c("Kipb", "Dprovi", "Dkabup", "Disic5", "Year",
           "Pwtlpi", "Pwtlpa", "Pwtlni", "Pwtlna", "Pttlpi", "Pttlpa", "Pttlni", "Pttlna",   #tk_laki
           "Pwtppi", "Pwtppa", "Pwtpni", "Pwtpna", "Pttppi", "Pttppa", "Pttpni", "Pttpna",   #tk_perem 
           "Ptdpri", "Ptdpra", "Ptdnpi", "Ptdnpa", #tk_takdibayar (dimasukkan ke tk_perem saja)
           "Lprnol", "Lprnof", #tk_prod
           "Lnpnol", "Lnpnof", #tk_lain
           "Lprnof", "Lnpnof", #tk_asing
           "Zpdvcu", #pengpek_prod
           "Zndvcu" #pengpek_lain
           )
  
stpim22_imptpt_var <- stpim22_imptpt |>
  select(all_of(var22))

stpim21_imptpt_var <- stpim21_imptpt |>
  select(all_of(var21))


#kelompokkan basis data historis 2020-2022 >> mapping variabel apa yang diperlukan: kipb, dprovi, dkabup, disic5, rincian tk, pengeluaran pekerja, rincian output, rincian input.
#imputasi tk untuk sisanya

target_imptpt

## variabel imputasi?
## model apa imputasi? rasio? ml?
## tk : historis 22
## pengeluaran pekerja : historis 22
## total output : rasio/ml?
## breakdown output : rasio komponen?
## biaya input?

```


