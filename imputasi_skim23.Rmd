---
title: "Imputasi SKIM23"
author: "Ayu Paramudita"
output:
  html_document:
    toc: true
    toc_depth: 2
code-fold: true
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(dplyr)
library(knitr)
library(writexl)
library(tidyr)
library(ggplot2)

#package untuk machine learning
library(caret)
library(Metrics)
library(randomForest)
```


# Investigasi target imputasi

## Load data

```{r, warning=FALSE}
dpa23   <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/DPA NASIONAL tahun 2023.xlsx")
skim23  <- read_xlsx("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/SKIM.IIADetail NASIONAL tahun 2024.xlsx")

stpim23 <- read_xlsx("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/STPIM (CAWI) NASIONAL tahun 2024.xlsx")
weight23 <- read.csv2("D:/##AYUPA DESKTOP 2/Imputasi SKIM23/2024-12-23 10_02_52 Weight STPIM 2024(Sheet1).csv")

```


## Data DPA23 TPT

```{r }
dpa23_tpt <- dpa23 |>
  mutate(kbli2_dpa23 = substr(b2r217, 1, 2)) |>
  filter(b2r205 == 1,                            # kondisi aktif
         b2r210 != 4,                            # bukan kantor pusat
         kbli2_dpa23 == 13 | kbli2_dpa23 == 14              # kbli 13 dan 14
         ) |>
  select(kip, prov, kab, b2r217, kbli2_dpa23, b2r205, b2r210, b2r224, b2r225, b2r226, b2r218)

# Buat tabel
tab_dpa23tpt <- table(dpa23_tpt$kbli2_dpa23)
tab_dpa23tpt <- as.data.frame(tab_dpa23tpt) |>
  rename(KBLI = Var1,
         N    = Freq) 

total_dpatpt23 <- data.frame(KBLI = "Total", N = sum(tab_dpa23tpt$N))
tab_dpa23tpt <- rbind(tab_dpa23tpt, total_dpatpt23)
tab_dpa23tpt <- kable(tab_dpa23tpt)

```

Referensi **target usaha awal**: DPA23 kondisi 1 (aktif), KBLI 13-14, dan selain kantor pusat. *Kenapa **target usaha awal**? Karena nanti di akhir setelah imputasi akan dicek kembali (range tenaga kerja, investasi, omset, badan usaha/hukum, dll dari DPA23) mana yang layak masuk sebagai mfg/data final.*

Jumlah target usaha TPT (KBLI 13 & 14) menurut DPA23: **`r nrow(dpa23_tpt)`**. 

Dengan rincian sebagai berikut: `r tab_dpa23tpt`.


## Cek SKIM23

```{r }
skim23 <- skim23 |>
  mutate(kbli2 = substr(r201_kode, 1, 2))

# Buat tabel
tab_skim23 <- table(skim23$kbli2)
tab_skim23 <- as.data.frame(tab_skim23) |>
  rename(KBLI = Var1,
         N    = Freq) 

total_skim23 <- data.frame(KBLI = "Total", N = sum(tab_skim23$N))
tab_skim23 <- rbind(tab_skim23, total_skim23)
tab_skim23 <- kable(tab_skim23)

nkbli_na <- sum(is.na(skim23$kbli2))   

```

Jumlah perusahaan TPT di SKIM23 : **`r nrow(skim23)`**

`r tab_skim23`

**KBLI yang NA : `r nkbli_na`**


## Target usaha SKIM yang perlu imputasi dengan dasar jumlah usaha dari DPA23 TPT

```{r }
target_imptpt <- dpa23_tpt |>
  filter(!(kip %in% skim23$kip))

```

**Target imputasi TPT: `r nrow(target_imptpt)`.**


## Cek DPA23 TPT dengan weight STPIM23

Catatan: weight STPIM23 adalah dokumen berisi list KIP usaha STPIM23 dan penimbangnya.

```{r}
# Cek irisan DPA23 TPT dan weight STPIM23
cek_dpa23tpt_weight <- dpa23_tpt |>
  filter((kip %in% weight23$kipb))

```

Tidak ada irisan DPA23 TPT dengan weight: aman.
Sehingga, target imputasi TPT **`r nrow(target_imptpt)`**.


## Cek STPIM23 TPT dan weight STPIM23

```{r, results='hide'}
# Cek usaha TPT di STPIM23
stpim23_tpt <- stpim23 |>
  mutate(kbli2 = substr(r201_kode, 1, 2)) |>
  filter(kbli2 == 13 | kbli2 == 14)

list_stpim23_tpt <- print(stpim23_tpt$kip)

total_tpt23 <- nrow(stpim23_tpt) + nrow(target_imptpt) + nrow(skim23)
```

Ternyata masih ada `r nrow(stpim23_tpt)` usaha TPT yang dicatat di STPIM23. 
Apakah `r nrow(stpim23_tpt)` usaha 13-14 STPIM23 ini ada di weight?

```{r}
# Cek irisan STPIM23 dan weight
cek_stpim23tpt_weight <- stpim23_tpt |>
  filter((kip %in% weight23$kipb))

```

Ada `r nrow(cek_stpim23tpt_weight)` usaha 13-14 yang ada di weight. Maka, dokumen weight harus diupdate dengan mengeluarkan 3 usaha 13-14 ini. KIP `r nrow(cek_stpim23tpt_weight)` perusahaan tersebut a.l.: `r cek_stpim23tpt_weight$kip`.

**`r nrow(stpim23_tpt)` usaha 13-14 STPIM23 harus masuk menjadi cakupan SKIM23**. *Jangan lupa untuk dimasukkan saat mengkompilasi data SKIM23 untuk tabulasi nanti*. KIP `r nrow(stpim23_tpt)` perusahaan tersebut a.l.:

`r list_stpim23_tpt`

**Sehingga populasi usaha TPT 2023 (cakupan SKIM23) sebesar : `r total_tpt23`** (`r nrow(stpim23_tpt)` STPIM23 TPT + `r nrow(target_imptpt)` Target Imputasi + `r nrow(skim23)` SKIM23).


# Imputasi tenaga kerja dan upah

## Load data sumber imputasi

```{r, warning=FALSE}
stpim22 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg22.xlsx")
stpim21 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg21e.xlsx")
#stpim20 <- read_xlsx("D:/##AYUPA DESKTOP 2/DATA INDUSTRI/mfg20f.xlsx")

stpim22 <- stpim22 |>
  mutate(kbli2_stpim = substr(Disic522, 1, 2))

stpim21 <- stpim21 |>
  mutate(kbli2_stpim = substr(Disic521, 1, 2))
```

## Cek irisan target imputasi dengan STPIM22, STPIM21, dan STPIM20

Cek irisan ini bertujuan untuk mendapatkan basis data dari data historis masing-masing KIP yang ingin diimputasi.

```{r }
# irisan target imputasi dengan stpim22
stpim22_imptpt <- stpim22 |>
  filter(Kipb %in% target_imptpt$kip) 

# sisa target imputasi & tambahan informasi variabel tk, inves, omset dari dpa23
sisa_target22 <- target_imptpt |>
  filter(!(kip %in% stpim22_imptpt$Kipb)) |>
  left_join(dpa23, by = "kip") |>
  select(kip, prov.x, kab.x, b2r217.x, kbli2_dpa23, b2r205.x, b2r210.x, b2r224.x, b2r225.x, b2r226.x, b2r218.x) |>
  rename(prov = prov.x,
         kab  = kab.x,
         b2r217 = b2r217.x,
         b2r205 = b2r205.x,
         b2r210 = b2r210.x,
         b2r224 = b2r224.x,
         b2r225 = b2r225.x,
         b2r226 = b2r226.x,
         b2r218 = b2r218.x)

# irisan target imputasi dengan stpim21
stpim21_imptpt <- stpim21 |>
  filter(Kipb %in% sisa_target22$kip)

# sisa target imputasi 
sisa_target21 <- sisa_target22 |>
  filter(!(kip %in% stpim21_imptpt$Kipb))

```

Dari target imputasi TPT sebanyak **`r nrow(target_imptpt)`**, ditemukan irisan dengan data STPIM tahun-tahun sebelumnya sebagai sumber imputasi, a.l. sebanyak **`r nrow(stpim22_imptpt)` KIP dari STPIM22, `r nrow(stpim21_imptpt)` dari STPIM21**, sisanya `r nrow(sisa_target21)` KIP tidak ditemukan di STPIM21 dan STPIM22. Basis data STPIM20 tidak digunakan karena irisan yang tersisa tinggal KIP yang semuanya nonrespon di STPIM20.

**`r nrow(sisa_target21)` KIP tanpa historis data STPIM akan diimputasi dengan tenaga kerja = 20** dengan pertimbangan bahwa skala usaha berdasarkan variabel tenaga kerja, investasi, dan omset di DPA23nya masing-masing adalah skala usaha mikro dan kecil.

## Mapping variabel dan imputasi tenaga kerja dan upah sebagai variabel dasar

Langkah-langkah yang dilakukan di tahap ini:

- Mapping nama variabel STPIM21, STPIM22, SKIM23 (acuan variabel SKIM23).
- Mensinkronkan variabel STPIM21 dan STPIM22 sesuai dengan SKIM23.
- Melakukan imputasi tenaga kerja dengan tenaga kerja tahun sebelumnya.
- Melakukan imputasi upah dengan upah sebelumnya dengan adjustment rata-rata pertumbuhan UMP sebesar 7,5 persen.
[Tautan sumber dasar imputasi - Klik di sini](https://www.suara.com/news/2023/01/01/190351/rincian-lengkap-ump-2023-yang-mulai-berlaku-1-januari)

```{r }
#menghapus tahun di nama variabel
stpim22_imptpt <- stpim22_imptpt |>
  rename_with(~ gsub("22$", "", .))

stpim21_imptpt <- stpim21_imptpt |>
  rename_with(~ gsub("21$", "", .))

# Mapping nama variabel
var22 <- c("Kipb", "Dprovi", "Dkabup", "Disic5", "Year",
        # TK dan Upah
           "Lpmnop", "Lpmnon", "Lnmnop", "Lnmnon", #tk_laki
           "Lpwnop", "Lpwnon", "Lnwnop", "Lnwnon", #tk_perem
           "Lprnop", "Lprnon", #tk_prod
           "Lnpnop", "Lnpnon", #tk_lain
           "Ltlnof", #tk_asing
           "Zptvcu", "Zprvcu", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
           "Zntvcu", "Znrvcu", #pengpek_lain = upah_tklain + pengpeklain_tklain
           "Zpdvcu", #pengpek_prod
           "Zndvcu") #pengpek_lain
        
         # Komposisi Biaya INPUT
         #  "Rdnvcu", "Rimvcu", #bbakupen_dom #bbakupen_imp
        #   "Efuvcu", "Eplvcu", "Enpvcu", #bbakar #listrik_pln #listrik_nonpln
        #   "Ibrvcu", #sewagdg
        #   "Ilrvcu", "Itxvcu", "Iinvcu", "Icovcu", "Idevcu", "Iprvcu", #sewatnh #pajak #bunga #hibah #deviden #premi
        #   "Ipkvcu", "Irdvcu", "Iklvcu", "Ikdvcu",  #kemasan #rnd #haki_dom #haki_ln
        #   "Iislov", #Iisfov, #peng_maklun_dom #peng_maklun_ln
        #   "Iuwvcu", "Iotvcu" #air #peng_lainlain
        #   )

var21 <- c("Kipb", "Dprovi", "Dkabup", "Disic5", "Year",
        # TK dan Upah
           "Pwtlpi", "Pwtlpa", "Pwtlni", "Pwtlna", "Pttlpi", "Pttlpa", "Pttlni", "Pttlna",   #tk_laki
           "Pwtppi", "Pwtppa", "Pwtpni", "Pwtpna", "Pttppi", "Pttppa", "Pttpni", "Pttpna",   #tk_perem 
           "Ptdpri", "Ptdpra", "Ptdnpi", "Ptdnpa", #tk_takdibayar (dimasukkan ke tk_perem saja)
           "Lprnol", "Lprnof", #tk_prod
           "Lnpnol", "Lnpnof", #tk_lain
           "Lprnof", "Lnpnof", #tk_asing
           "Zptvcu", "Zpevcu", "Zphvcu", "Zprvcu", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
           "Zntvcu", "Znevcu", "Znhvcu", "Znrvcu", #pengpek_lain = upah_tklain + pengpeklain_tklain
           "Zpdvcu", #pengpek_prod
           "Zndvcu") #pengpek_lain
        # Komposisi Biaya INPUT
        #   "Rdnvcu", "Rimvcu", #bbakupen_dom #bbakupen_imp
        #   "Efuvcu", "Eplvcu", "Enpvcu", #bbakar #listrik_pln #listrik_nonpln
        #   "Ibrvcu", #sewagdg
        #   "Ilrvcu", "Itxvcu", "Iinvcu", "Icovcu", "Idevcu", "Iprvcu", #sewatnh #pajak #bunga #hibah #deviden #premi
        #   "Ipkvcu", "Irdvcu", "Iklvcu", "Ikdvcu",  #kemasan #rnd #haki_dom #haki_ln
        #   "Iislov", #Iisfov, #peng_maklun_dom #peng_maklun_ln
        #   "Iuwvcu", "Iotvcu" #air #peng_lainlain
        #   )

varskim23 <- c("tahun", "kip", "prov", "kab", "r201_kode", "r203", "Disic5", "b2r217",
          # TK dan Upah
               "r206b_1", #tk_laki
               "r206b_2", #tk_perem
               "r206c_1", #tk_prod
               "r206c_2", #tk_lain
               "r206d", #tk_asing
               "r206a", #total_tk
               "r301a_1", "r301a_2", #pengpek_prod = upah_tkprod + pengpeklain_tkprod
               "r301b_1", "r301b_2", #pengpek_lain = upah_tklain + pengpeklain_tklain
               "r301c") #total_upah
          # Komposisi Biaya INPUT
         #      "r501k5_sum", "r501k7_sum", #bbakupen_dom #bbakupen_imp
        #       "r303a", "r304c", #bbakar #listrik
        #       "r305a", #sewagdg 
        #       "r305b", "r306", "r307", "r308", "r309", "r310", #sewatnh #pajak #bunga #hibah #deviden #premi
        #       "r311", #peng_maklun
        #       "r312", "r313" #air #peng_lainlain
        #       )

# Sync variabel dan nama var ke SKIM23 & Imputasi TK dan Pengeluaran Pekerja
stpim22_imptpt <- stpim22_imptpt |>
  mutate(tahun   = 2022,
         r201_kode = NA,
         b2r217    = NA,
         r206b_1 = rowSums(across(c("Lpmnop", "Lpmnon", "Lnmnop", "Lnmnon")), na.rm = TRUE),  #tk_laki
         r206b_2 = rowSums(across(c("Lpwnop", "Lpwnon", "Lnwnop", "Lnwnon")), na.rm = TRUE), #tk_perem
         r206c_1 = rowSums(across(c("Lprnop", "Lprnon")), na.rm = TRUE), #tk_prod
         r206c_2 = rowSums(across(c("Lnpnop", "Lnpnon")), na.rm = TRUE), #tk_lain
         r206d   = Ltlnof, #tk_asing
         r206a   = rowSums(across(c("r206b_1", "r206b_2")), na.rm = TRUE), #total_tk
         r301a_1 = 1.075 * Zptvcu, #upah_tkprod
         r301a_2 = 1.075 * Zprvcu, #pengpeklain_tkprod
         r301b_1 = 1.075 * Zntvcu, #upah_tklain
         r301b_2 = 1.075 * Znrvcu, #pengpeklain_tklain
         r301c   = rowSums(across(c("r301a_1", "r301a_2", "r301b_1", "r301b_2")), na.rm = TRUE) #total_upah
         ) |>
  rename(kip       = Kipb,
         prov      = Dprovi,
         kab       = Dkabup,
         r203      = Year)

stpim21_imptpt <- stpim21_imptpt |>
  mutate(tahun = 2021,
         r201_kode = NA,
         b2r217    = NA,
         r206b_1 = rowSums(across(c("Pwtlpi", "Pwtlpa", "Pwtlni", "Pwtlna", 
                                    "Pttlpi", "Pttlpa", "Pttlni", "Pttlna")), na.rm = TRUE),  #tk_laki
         r206b_2 = rowSums(across(c("Pwtppi", "Pwtppa", "Pwtpni", "Pwtpna", 
                                    "Pttppi", "Pttppa", "Pttpni", "Pttpna", 
                                    "Ptdpri", "Ptdpra", "Ptdnpi", "Ptdnpa")), na.rm = TRUE), #tk_perem
         r206c_1 = rowSums(across(c("Lprnol", "Lprnof")), na.rm = TRUE), #tk_prod
         r206c_2 = rowSums(across(c("Lnpnol", "Lnpnof")), na.rm = TRUE), #tk_lain
         r206d   = rowSums(across(c("Lprnof", "Lnpnof")), na.rm = TRUE), #tk_asing
         r206a   = rowSums(across(c("r206b_1", "r206b_2")), na.rm = TRUE), #total_tk
         r301a_1 = 1.075 * Zptvcu, #upah_tkprod
         r301a_2 = 1.075 * rowSums(across(c("Zpevcu", "Zphvcu", "Zprvcu")), na.rm = TRUE), #pengpeklain_tkprod
         r301b_1 = 1.075 * Zntvcu, #upah_tklain
         r301b_2 = 1.075 * rowSums(across(c("Znevcu", "Znhvcu", "Znrvcu")), na.rm = TRUE), #pengpeklain_tklain
         r301c   = rowSums(across(c("r301a_1", "r301a_2", "r301b_1", "r301b_2")), na.rm = TRUE) #total_upah
         ) |>
  rename(kip       = Kipb,
         prov      = Dprovi,
         kab       = Dkabup,
         r203      = Year)

```

- Mengimputasi sisa KIP tanpa histori data dengan TK = 20, Upah = tk x 12 bulan operasional x UMP (asumsi UMP Jabar & Jateng 1,9juta)

```{r}
sisa_target21 <- sisa_target21 |>
  mutate(tahun = 0000,
         r203    = 12,  #bulan operasi
         r206b_1 = 20,  #tk_laki
         r206b_2 =  0,  #tk_perem
         r206c_1 = 20,  #tk_prod
         r206c_2 =  0,  #tk_lain
         r206d   =  0, #tk_asing
         r206a   = rowSums(across(c("r206b_1", "r206b_2")), na.rm = TRUE), #total_tk
         r301a_1 = r206b_1 * r203 * 1900, #upah_tkprod (asumsi: produksi 12 bulan, UMP Jabar Jateng ~1,9juta)
         r301a_2 =  0, #pengpeklain_tkprod
         r301b_1 =  0, #upah_tklain
         r301b_2 =  0, #pengpeklain_tklain
         r301c   = rowSums(across(c("r301a_1", "r301a_2", "r301b_1", "r301b_2")), na.rm = TRUE), #total_upah
         r201_kode = NA,
         b2r217    = NA,
         Disic5    = NA
         )
```

- Menyatukan semua sumber data historis imputasi menjadi satu dataset.

```{r}
# Combine dataset STPIM22, STPIM21, dan no histori KIP
stpim_imptpt <- stpim22_imptpt |>
  select(all_of(varskim23)) |>
  bind_rows(select(stpim21_imptpt, all_of(varskim23))) |>
  bind_rows(select(sisa_target21, all_of(varskim23))) |>
  left_join(target_imptpt[c("kip", "b2r217")], by = "kip") |>
  select(-b2r217.x) |>
  rename(b2r217 = b2r217.y) |> 
  mutate(kbli2_dpa23 = substr(b2r217, 1, 2),
         kbli2_stpim = substr(Disic5, 1, 2))

```

## Cek konsistensi KBLI di STPIM dan DPA

Pengecekan dan penetapan KBLI diperlukan karena KBLI sebagai dasar imputasi lebih lanjut.

- Cek apakah ada target yang memiliki historis STPIM yang KBLI-nya bukan TPT? 
- Cek KBLI dan produksi perusahaan yang terindikasi bukan TPT.
- Keluarkan yang kira-kira bukan TPT.
- Update KBLI yang sudah dicek dengan imputasi dari sumber DPA yang dicek benar.
- KBLI dasar untuk imputasi yang digunakan adalah KBLI STPIM dengan asumsi pemeriksaan STPIM berjalan dengan benar.

```{r}
cek_kbli <- stpim_imptpt |> 
  filter(kbli2_stpim != 13 & kbli2_stpim != 14) |>
  left_join(dpa23[c("kip", "b2r216")], by = "kip") |>
  left_join(stpim22[c("Kipb", "Produksi")], by = c("kip" = "Kipb")) |>
  rename(produksi_dpa23 = b2r216,
         produksi_stpim = Produksi)

list_cek_kbli <- cek_kbli |>
  select(kip, Disic5, b2r217, kbli2_stpim, kbli2_dpa23, produksi_stpim, produksi_dpa23, tahun) |>
  print()

#write_xlsx(cek_kbli, "cek_kbli.xlsx")

#KIP yang sudah dicek dan diindikasi bukan TPT
cek_kbli_nontpt <- c(311390007, 311390456, 311510118, 311810306, 312210019, 321311729, 
                     321311804, 321311819, 321390608, 321391680, 321391771, 321412390, 
                     321510033, 321720004, 322100212, 322931973, 331020610, 331391969, 
                     332930002, 333100045, 341390020, 351310950, 351390042, 351390102, 
                     351390414, 351391068, 351391079, 351411144, 352220076, 361390162, 
                     321410652)

#Keluarkan perusahaan non-TPT
stpim_imptpt <- stpim_imptpt |>
  filter(!(kip %in% cek_kbli_nontpt))

#Update KBLI
stpim_imptpt <- stpim_imptpt |>
  #Update KBLI STPIM hasil pengecekan dengan KBLI DPA
  mutate(Disic5      = ifelse((kbli2_stpim != 13 & kbli2_stpim != 14), b2r217, Disic5),
         kbli2_stpim = ifelse((kbli2_stpim != 13 & kbli2_stpim != 14), kbli2_dpa23, kbli2_stpim)) |>
  #Imputasi KBLI untuk KIP tanpa histori dengan KBLI dari DPA23
  mutate(Disic5      = ifelse(is.na(kbli2_stpim), b2r217, Disic5),
         kbli2_stpim = ifelse(is.na(kbli2_stpim), kbli2_dpa23, kbli2_stpim))

```

Ada `r nrow(cek_kbli)` KIP dengan KBLI dari STPIM yang bukan TPT. Setelah dilakukan pengecekan, `r length(cek_kbli_nontpt)` KIP dieliminasi karena bukan industri TPT.

**Target imputasi sekarang menjadi: `r nrow(stpim_imptpt)` perusahaan.**


# Imputasi komponen biaya input

Imputasi komponen biaya input dilakukan dengan pendekatan pertumbuhan komponen biaya input dari data tahun sebelumnya, dengan langkah-langkah sebagai berikut.

## Menghitung pertumbuhan biaya input sebagai adjustment imputasi

- Menghitung pertumbuhan biaya input 2022 terhadap 2021 per provinsi, per 2 digit KBLI, dan skala tenaga kerja. Variasi pertumbuhan biaya input pada KBLI 13 maupun 14 sangat heterogen antarprovinsi seperti yang ditunjukkan oleh Grafik di bawah.

```{r}
stpim22_tpt <- stpim22 |>
  filter(kbli2_stpim == 13 | kbli2_stpim == 14) |>
  rowwise() |>  # Ensure operations are performed row-wise
  mutate(skala_tk = sum(Lprnop22, Lprnon22, Lnpnop22, Lnpnon22, na.rm = TRUE)) |> 
  mutate(skala_tk = ifelse(skala_tk > 99, "B", "S")) |> 
  ungroup()  # Remove row-wise grouping for further operations

stpim21_tpt <- stpim21 |>
  filter(kbli2_stpim == 13 | kbli2_stpim == 14) |>
  rowwise() |>  # Ensure operations are performed row-wise
  mutate(skala_tk = sum(Lprnol21, Lprnof21, Lnpnol21, Lnpnof21, na.rm = TRUE)) |> 
  mutate(skala_tk = ifelse(skala_tk > 99, "B", "S")) |> 
  ungroup()  # Remove row-wise grouping for further operations


#Mengelompokkan berdasarkan provinsi dan kbli2 
sum_inp22 <- stpim22_tpt |>
  group_by(Dprovi22, kbli2_stpim, skala_tk) |>
  summarise(total_inp22 = sum(Iinput22, na.rm = TRUE), 
            mean_inp22 = mean(Iinput22, na.rm = TRUE),        #mean input untuk imputasiobservasi yang no histori
            .groups = "drop") |>
  mutate(prov_kbli2_skala = paste(Dprovi22, kbli2_stpim, skala_tk, sep = ""))

sum_inp21 <- stpim21_tpt |>
  group_by(Dprovi21, kbli2_stpim, skala_tk) |>
  summarise(total_inp21 = sum(Iinput21, na.rm = TRUE), .groups = "drop") |>
  mutate(prov_kbli2_skala = paste(Dprovi21, kbli2_stpim, skala_tk, sep = ""))


#Menghitung pertumbuhan biaya input per provinsi dan kbli2
sum_inp21 <- sum_inp21 |>
  left_join(sum_inp22[,c("prov_kbli2_skala", "total_inp22")], by = "prov_kbli2_skala") |>
  mutate(
    grwt_inp = ifelse(
      !is.na(total_inp21) & !is.na(total_inp22), 
      (total_inp22 - total_inp21) / total_inp21 * 100, 
      NA_real_
    )
  ) |>
  arrange(grwt_inp)

```

```{r}
#Filter data 
sum_inp21_13 <- sum_inp21 |>
  filter(kbli2_stpim == 13) |>
  filter(!(is.na(grwt_inp)))
         
sum_inp21_14 <- sum_inp21 |>
  filter(kbli2_stpim == 14) |>
  filter(!(is.na(grwt_inp)))
         

#Barplot pertumbuhan input KBLI 13
ggplot(sum_inp21_13, aes(x = reorder(Dprovi21, grwt_inp), y = grwt_inp)) +
  geom_bar(aes(fill = skala_tk), stat = "identity") +  # Fill color based on skala
  geom_text(aes(label = round(grwt_inp, 0)),  
            hjust = -0.1, 
            size = 3.5,
            colour = "gray") +  
  scale_fill_manual(values = c("B" = "navy", "S" = "maroon")) +  # Custom colors
  labs(title = "Pertumbuhan Input KBLI 13 per Provinsi (%)",
       x = "Provinsi",
       y = "Pertumbuhan (%)") +
  theme_minimal() +
  coord_flip()  # Flip for readability


#Barplot pertumbuhan input KBLI 14
ggplot(sum_inp21_14, aes(x = reorder(Dprovi21, grwt_inp), y = grwt_inp)) +
  geom_bar(aes(fill = skala_tk), stat = "identity") +  # Fill color based on skala
  geom_text(aes(label = round(grwt_inp, 0)),  
            hjust = -0.1, 
            size = 3.5,
            colour = "gray") +  
  scale_fill_manual(values = c("B" = "navy", "S" = "maroon")) +  # Custom colors
  labs(title = "Pertumbuhan Input KBLI 14 per Provinsi (%)",
       x = "Provinsi",
       y = "Pertumbuhan (%)") +
  theme_minimal() +
  coord_flip()  # Flip for readability


```

- Setelah didapatkan data histori pertumbuhan input 2022 terhadap 2021, match-kan dengan provinsi dan KBLI target imputasi 2023. 
- Jika ada yang tidak memiliki pertumbuhan input dikarenakan tidak adanya data histori, maka pendekatan dilakukan dengan melakukan imputasi pertumbuhan dengan median pertumbuhan seluruh observasi per provinsi kbli2 skala.
- Jika pertumbuhan biaya input terlalu ekstrem (kurang dari -40 persen s.d. lebih dari 400 persen), lakukan penyesuaian dengan men-setting range menjadi [-40 persen, 400 persen] (Pertimbangan: Provinsi Jateng pertumbuhannya -39 persen, sehingga ditetapkan -40 persen sebagai batas agar dapat mempertahankan fenomena TPT di provinsi dominan TPT).

```{r}
#Match pertumbuhan per provinsi, KBLI, dan skala dari data historis dengan target imputasi 2023
tab_stpim_imptpt <- stpim_imptpt |>
  mutate(skala_tk = ifelse(r206a > 99, "B", "S")) |> 
  group_by(prov, kbli2_stpim, skala_tk) |>
  summarise(total_nimp = n(), .groups = "drop") |>
  mutate(prov_kbli2_skala = paste(prov, kbli2_stpim, skala_tk, sep = "")) |>
  left_join(sum_inp21[, c("prov_kbli2_skala", "grwt_inp")], by = "prov_kbli2_skala") |>
  # Adjustment for no history data
  mutate(grwt_inp_imp = ifelse(is.na(grwt_inp), median(grwt_inp, na.rm = TRUE), grwt_inp)) |>  
  # Adjustment for outlier growth
  mutate(grwt_inp_imp = ifelse(grwt_inp_imp <= -40, -40, grwt_inp_imp)) |>
  mutate(grwt_inp_imp = ifelse(grwt_inp_imp >= 400, 400, grwt_inp_imp))

```

## Mengimputasi komposisi biaya input

- Melakukan imputasi komposisi biaya input dengan adjustment pertumbuhan biaya input 22-21 per KBLI2 per prov. Komponen biaya input yang diimputasi hanya terbatas, a.l. bahan baku dan penolong, bahan bakar, dan listrik.

```{r}
var2221_inp <- c("kip",
                 "Rdnvcu", "Rimvcu",                #bbakupen_dom #bbakupen_imp
                 "Efuvcu", "Eplvcu", "Enpvcu"       #bbakar #listrik_pln #listrik_nonpln
                 )     

stpim_imptpt_input <- stpim_imptpt |> 
  #combine data historis input 2022 dan 2021 jadi satu dataset
  left_join(
    bind_rows(
      stpim22_imptpt[var2221_inp] |> mutate(tahun = 2022),
      stpim21_imptpt[var2221_inp] |> mutate(tahun = 2021)
    )[var2221_inp], 
    by = "kip") |>
  mutate(skala_tk = ifelse(r206a > 99, "B", "S"),
         prov_kbli2_skala = paste(prov, kbli2_stpim, skala_tk, sep = "")) |>
  left_join(tab_stpim_imptpt[, c("prov_kbli2_skala", "grwt_inp_imp")], by = "prov_kbli2_skala") |>
  #adjust dengan growth
  mutate(r501k5_sum = Rdnvcu * ((100 + grwt_inp_imp) / 100),              #bbakupen_dom
         r501k7_sum = Rimvcu * ((100 + grwt_inp_imp) / 100),              #bbakupen_imp
         r303a      = Efuvcu * ((100 + grwt_inp_imp) / 100),              #bbakar
         r304c      = (Eplvcu + Enpvcu) * ((100 + grwt_inp_imp) / 100),   #listrik
         cek_input  = r501k5_sum + r501k7_sum + r303a + r304c
  ) |>
  select(tahun, kip, prov, kab, Disic5, kbli2_stpim, skala_tk, prov_kbli2_skala, 
         grwt_inp_imp, r501k5_sum, r501k7_sum, r303a, r304c, cek_input)

#format numerik
options(scipen = 999) 

```

- Imputasi no data histori (termasuk jika ada yang memiliki data histori tetapi total input 0): imputasi dilakukan dengan menggunakan nilai rata-rata input tahun 2022 menurut provinsi, kbli2, dan skala tk.

```{r}
#Match rata-rata input per provinsi, KBLI, dan skala dari data historis dengan target imputasi 2023
tab_stpim_imptpt <- tab_stpim_imptpt |>
  left_join(sum_inp22[, c("prov_kbli2_skala", "mean_inp22")], by = "prov_kbli2_skala") |>
  # Adjustment untuk observasi yang tidak memiliki history data dengan nilai persentil-25 
  # karena hanya ada 1 observasi NA dari provinsi Aceh
  mutate(mean_inp22_imp = ifelse(is.na(mean_inp22), quantile(mean_inp22, probs = 0.25, na.rm = TRUE), mean_inp22))
  
#Ceplokkan ke dataset stpim_imptpt_input
stpim_imptpt_input <- stpim_imptpt_input |>
  left_join(tab_stpim_imptpt |> select(prov_kbli2_skala, mean_inp22_imp), by = "prov_kbli2_skala") |>
  mutate(r501k5_sum = ifelse((is.na(cek_input) | cek_input == 0), mean_inp22_imp, r501k5_sum)) |>
  mutate(across(c(r501k5_sum, r501k7_sum, r303a, r304c), ~ replace_na(.x, 0)),
         input  = r501k5_sum + r501k7_sum + r303a + r304c)

#Jadikan satu dengan main dataset
stpim_imptpt <- stpim_imptpt |>
  left_join(stpim_imptpt_input |> 
              select(kip, r501k5_sum, r501k7_sum, r303a, r304c, input), by = "kip")
  

```

# Imputasi output

Imputasi output dilakukan dengan machine learning dengan langkah:

- Training data dan menentukan model
- Imputasi data output dengan model terpilih

## Data preparation

Data yang digunakan untuk data training adalah data 2022. 
Sementara variabel yang digunakan untuk mengestimasi output a.l.: provinsi, kbli2, bulan operasi, tenaga kerja, dan input.

```{r}
# Menyiapkan data 2022 sebagai data dasar untuk modeling
stpim22_tpt_ml <- stpim22_tpt |>
  select(Kipb, Dprovi22, Disic522, Year, Output22, Iinput22, Lprnop22, Lprnon22, Lnpnop22, Lnpnon22) |>
  mutate(kbli2_stpim = substr(Disic522, 1, 2),
         r206a       = rowSums(across(c("Lprnop22", "Lprnon22",                       #tk_prod
                                        "Lnpnop22", "Lnpnon22")), na.rm = TRUE)) |>   #tk_lain
  rename(kip    = Kipb,
         prov   = Dprovi22,
         r203   = Year,
         output = Output22,
         input  = Iinput22) |>
  select(kip, prov, kbli2_stpim, r203, r206a, output, input)

# Cleaning data karena masih ada data tidak wajar: input 0
stpim22_tpt_ml <- stpim22_tpt_ml |>
  filter(input > 0)

# Melihat pola data >> menyingkirkan outlier
ggplot(stpim22_tpt_ml, aes(x = input, y = output, color = as.factor(kbli2_stpim))) +
  geom_point(alpha = 0.7) +  # Scatter points with transparency
  labs(
    title = "Scatter Plot of Output vs Input by KBLI2",
    x = "Input",
    y = "Output",
    color = "KBLI2"
  ) +
  theme_minimal()

```

Terlihat sebaran data masih ada outlier di mana input sangat kecil, tetapi output sangat tinggi. 

Catatan: Setelah dicek, KIP 331411444 (titik biru pojok kiri atas) merupakan perusahaan maklun di mana nilai input berasal dari listrik dan lainnya, tanpa nilai bahan baku.

## Data split 

Dataset 2022 dibagi menjadi 2 : training (80 persen) dan testing (20 persen).

```{r}
# Split data training and testing
set.seed(888)
trainIndex <- createDataPartition(stpim22_tpt_ml$output, p = 0.8, list = FALSE, times = 1)

train_data <- stpim22_tpt_ml[trainIndex,] |>
  select(-kip)
validation_data  <- stpim22_tpt_ml[-trainIndex,] |>
  select(-kip)

```

## Data training 

```{r}
# Model KNN
set.seed(6789)
knn_fit <- train(output ~ . ,
                 data = train_data,
                 method = "knn",
                 preProc = c("center", "scale"), #standardize
                 # Decide k parameter!
                 tuneGrid		= data.frame(.k = seq(from = 1, to = (ncol(train_data) - 1), by = 1)),  
                 trControl		= trainControl(method = "cv")
                 )
knn_fit
plot(knn_fit)

knn_preds <- predict(knn_fit, validation_data)
rmse(actual = validation_data$output, predicted = knn_preds)
# 272 839 740

# ceplok data yang mau diimputasi
knn_preds_stpimtpt <- predict(knn_fit, stpim_imptpt[c("prov", "kbli2_stpim", "r203", "r206a", "input")])
rmse(actual = stpim_imptpt$output, predicted = knn_preds_stpimtpt)

#isu di data training & testing tidak ada provinsi 11 

# Model RF
set.seed(6789)
rf_fit <- train(output ~ . ,
                data = train_data,
                method = "rf",
                tuneGrid		= data.frame(mtry = seq(from = 1, to = (ncol(train_data) - 1), by = 1)),
                ntree = 100,   # Decide ntree!!
                importance	= TRUE,
                trControl		= trainControl(method = "cv")
                )
rf_fit

rf_preds <- predict(rf_fit, validation_data)
rmse(actual = validation_data$output, predicted = rf_preds)
# 293 117 167


#Data upah masuk ga karena data input tidak termasuk upah


## variabel imputasi?
## model apa imputasi? rasio >> sd input? ml >> output?

## tk : historis
## pengeluaran pekerja : historis w/ adjustment growth avg UMP

## biaya input : historis w/ adjustment growth input by kbli2 & prov & skala tk
## breakdown input: bb dom, bb impor, bbakar, listrik

## total output : rasio/ml?
## breakdown output ??
```


